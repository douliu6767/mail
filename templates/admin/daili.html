{% extends "base.html" %}

{% block title %}ä»£ç†æ± ç®¡ç† - {{ system_title }}{% endblock %}

{% block head %}
<!-- ä¸ mailbox.html ç›¸åŒçš„åŸºç¡€æ ·å¼ï¼Œè¿›è¡Œé€‚é… -->
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --sidebar-width: 280px;
        --header-height: 70px;
        --transition: all 0.3s ease;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        line-height: 1.6;
        color: #334155;
        transition: var(--transition);
    }
    
    /* Sidebar Styles */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        z-index: 1000;
        transition: var(--transition);
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-logo {
        color: white;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        padding: 20px 0;
    }
    
    .nav-item {
        display: block;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        padding: 15px 25px;
        transition: var(--transition);
        border-left: 3px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.1);
        transform: translateX(-100%);
        transition: var(--transition);
    }
    
    .nav-item:hover::before {
        transform: translateX(0);
    }
    
    .nav-item:hover,
    .nav-item.active {
        color: white;
        background: rgba(255,255,255,0.15);
        border-left-color: white;
        transform: translateX(5px);
    }
    
    .nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Main Content */
    .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        transition: var(--transition);
    }
    
    .header {
        background: white;
        height: var(--header-height);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 999;
    }
    
    .header-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #64748b;
    }
    
    .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
    }
    
    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    /* Content Area */
    .content {
        padding: 30px;
    }
    
    /* Cards */
    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 25px;
        transition: var(--transition);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
    }
    
    .card-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .card-body {
        padding: 25px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
    }
    
    /* Table Styles */
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    table th,
    table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    
    table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
    }
    
    table tr:hover {
        background: #f8fafc;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideInUp 0.3s ease;
    }
    
    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
    }
    
    .modal-close:hover {
        color: #374151;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }
    
    .toast {
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transform: translateX(450px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }
    
    .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .toast.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    /* ä»£ç†ç®¡ç†ä¸“ç”¨æ ·å¼ */
    .proxy-tabs {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 25px;
    }
    
    .proxy-tab {
        padding: 12px 24px;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        position: relative;
        transition: var(--transition);
    }
    
    .proxy-tab.active {
        color: var(--primary-color);
    }
    
    .proxy-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary-color);
    }
    
    .proxy-tab-content {
        display: none;
    }
    
    .proxy-tab-content.active {
        display: block;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    
    .search-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: nowrap; /* Prevent wrapping unless specifically needed */
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 500px; /* Increased from 400px for better input experience */
        min-width: 0; /* Allow shrinking */
    }
    
    .search-box input {
        flex: 1;
        min-width: 200px; /* Increased from 150px for better input experience */
        padding: 10px 16px; /* Enhanced padding to match mailbox.html */
        border: 2px solid #e5e7eb;
        border-radius: 8px; /* Increased radius to match mailbox.html */
        font-size: 14px; /* Increased font size to match mailbox.html */
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Enhanced shadow to match mailbox.html */
    }
    
    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1); /* Enhanced focus shadow to match mailbox.html */
        transform: translateY(-1px); /* Added transform to match mailbox.html */
    }
    
    .search-box input::placeholder {
        color: #9ca3af;
        font-style: italic; /* Added italic style to match mailbox.html */
    }
    
    .page-controls select {
        padding: 10px 12px; /* Increased padding to match search input better */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Added shadow to match search input */
        transition: all 0.3s ease; /* Added transition for consistency */
        min-width: 120px; /* Ensure minimum width to prevent shrinking too much */
    }
    
    .page-controls select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .pagination-info {
        color: #6b7280;
        font-size: 14px;
        margin-right: 20px;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #374151;
        text-decoration: none;
        border-radius: 6px;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .page-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-badge.online {
        background: #dcfce7;
        color: #166534;
    }
    
    .status-badge.offline {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-badge.testing {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* Mobile menu toggle - default hidden */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
        transition: var(--transition);
    }
    
    .mobile-menu-toggle:hover {
        color: var(--primary-color);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .header-title {
            font-size: 20px;
        }
        
        .content {
            padding: 20px;
        }
        
        .mobile-menu-toggle {
            display: block !important;
        }
        
        .card-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .modal-content {
            width: 95%;
            margin: 20px;
        }
        
        .table-container {
            font-size: 12px;
        }
    }
    
    /* Mobile overlay */
    .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    
    .mobile-overlay.show {
        display: block;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .button-group {
            flex-direction: column;
        }
        
        .search-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            max-width: none;
        }
        
        .form-row {
            flex-direction: column;
        }
        
        .pagination-container {
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .proxy-tabs {
            overflow-x: auto;
            white-space: nowrap;
        }
    }
</style>
{% endblock %}

{% block body %}
<!-- Toast notification container -->
<div id="toast-container" class="toast-container"></div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“§ é‚®ä»¶ç®¡ç†ç³»ç»Ÿ</div>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('admin_home') }}" class="nav-item">
            <i>ğŸ </i> é¦–é¡µ
        </a>
        <a href="{{ url_for('admin_mailbox') }}" class="nav-item">
            <i>ğŸ“«</i> é‚®ç®±ç®¡ç†
        </a>
        <a href="{{ url_for('admin_daili') }}" class="nav-item active">
            <i>ğŸŒ</i> ä»£ç†æ± 
        </a>
        <a href="{{ url_for('admin_kami') }}" class="nav-item">
            <i>ğŸ”‘</i> å¡å¯†ç®¡ç†
        </a>
        <a href="{{ url_for('admin_kamirizhi') }}" class="nav-item">
            <i>ğŸ“</i> å¡å¯†æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_shoujian') }}" class="nav-item">
            <i>ğŸ“§</i> æ”¶ä»¶æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_system') }}" class="nav-item">
            <i>âš™ï¸</i> ç³»ç»Ÿè®¾ç½®
        </a>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
            <h1 class="header-title">ä»£ç†æ± ç®¡ç†</h1>
        </div>
        <div class="header-actions">
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ{{ admin_username }}</span>
            </div>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </div>
    
    <div class="content">
        <!-- å·¦ä¾§æ“ä½œæŒ‰é’® -->
        <div class="card" style="margin-bottom: 15px;">
            <div class="card-body" style="padding: 20px;">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="showAddProxyModal('http')">
                        â• æ·»åŠ HTTPä»£ç†
                    </button>
                    <button class="btn btn-primary" onclick="showAddProxyModal('socks5')">
                        â• æ·»åŠ SOCKS5ä»£ç†
                    </button>
                    <button class="btn btn-success" onclick="enableProxy()" id="enableProxyBtn">
                        ğŸš€ å¼€å¯ä»£ç†
                    </button>
                    <button class="btn btn-warning" onclick="disableProxy()" id="disableProxyBtn" style="display: none;">
                        â¹ï¸ å…³é—­ä»£ç†
                    </button>
                    <button class="btn btn-danger" onclick="batchDeleteProxies()" id="batchDeleteBtn" style="display: none;">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                    </button>
                </div>
                
                <!-- ä»£ç†çŠ¶æ€æ˜¾ç¤º -->
                <div id="proxyStatusPanel" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="proxyStatusIcon">ğŸŒ</span>
                        <strong>ä»£ç†çŠ¶æ€ï¼š</strong>
                        <span id="proxyStatusText">æœªå¯ç”¨</span>
                    </div>
                    <div id="proxyStatusDetails" style="margin-top: 8px; color: #6b7280; font-size: 14px;"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ä»£ç†æ± ç®¡ç†</h2>
            </div>
            <div class="card-body">
                <!-- æœç´¢å’Œåˆ†é¡µæ§åˆ¶ -->
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="proxySearchInput" placeholder="æœç´¢ä»£ç†åç§°ã€åœ°å€æˆ–å¤‡æ³¨..." onkeyup="searchProxies()">
                        <button class="btn btn-primary" onclick="searchProxies()">ğŸ” æœç´¢</button>
                        <button class="btn btn-danger" onclick="clearProxySearch()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="page-controls">
                        <select id="proxyPerPageSelect" onchange="changePerPage()">
                            <option value="10">æ¯é¡µ10æ¡</option>
                            <option value="20">æ¯é¡µ20æ¡</option>
                            <option value="50">æ¯é¡µ50æ¡</option>
                        </select>
                    </div>
                </div>
                
                <!-- ç»Ÿä¸€ä»£ç†åˆ—è¡¨ -->
                <div class="table-container">
                    <table id="proxyTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="proxySelectAll" onchange="toggleSelectAll()"></th>
                                <th>åºå·ID</th>
                                <th>ç±»å‹</th>
                                <th>ä»£ç†åç§°</th>
                                <th>åœ°å€:ç«¯å£</th>
                                <th>ç”¨æˆ·å</th>
                                <th>å¯†ç </th>
                                <th>çŠ¶æ€</th>
                                <th>å»¶è¿Ÿ</th>
                                <th>æœ€åæ£€æµ‹</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ç»Ÿä¸€ä»£ç†åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ è½½ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µå¯¼èˆª -->
                <div class="pagination-container" id="proxyPaginationContainer">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘ä»£ç†æ¨¡æ€æ¡† -->
<div id="proxyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="proxyModalTitle">æ·»åŠ HTTPä»£ç†</h3>
            <button class="modal-close" onclick="closeProxyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="proxyForm">
                <input type="hidden" id="proxyId" name="id">
                <input type="hidden" id="proxyType" name="type">
                <input type="hidden" id="proxyAction" name="action" value="add">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proxyName">ä»£ç†åç§°</label>
                        <input type="text" id="proxyName" name="name" 
                               placeholder="ç•™ç©ºå°†é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²">
                    </div>
                    
                    <div class="form-group">
                        <label for="proxyHost">ä»£ç†åœ°å€ *</label>
                        <input type="text" id="proxyHost" name="host" required 
                               placeholder="ä¾‹: 127.0.0.1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proxyPort">ç«¯å£ *</label>
                        <input type="number" id="proxyPort" name="port" required 
                               placeholder="ä¾‹: 8080">
                    </div>
                    
                    <div class="form-group">
                        <label for="proxyUsername">ç”¨æˆ·å</label>
                        <input type="text" id="proxyUsername" name="username" 
                               placeholder="å¯é€‰ï¼šä»£ç†ç”¨æˆ·å">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proxyPassword">å¯†ç </label>
                        <input type="password" id="proxyPassword" name="password" 
                               placeholder="å¯é€‰ï¼šä»£ç†å¯†ç ">
                    </div>
                    
                    <div class="form-group">
                        <label for="proxyRemarks">å¤‡æ³¨</label>
                        <input type="text" id="proxyRemarks" name="remarks" 
                               placeholder="å¯é€‰ï¼šä»£ç†å¤‡æ³¨">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeProxyModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-warning" onclick="testProxy()" id="testProxyBtn">æµ‹è¯•ä»£ç†</button>
            <button type="button" class="btn btn-primary" onclick="saveProxy()">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mobile menu functionality
    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        if (sidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }
    
    function openMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.add('mobile-open');
        overlay.classList.add('show');
    }
    
    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
    }
    
    // Close mobile menu when clicking on navigation items
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                closeMobileMenu();
            });
        });
    });

    // å…¨å±€å˜é‡
    let currentPage = 1;
    let perPage = 10;
    let searchQuery = '';
    let totalPages = 1;
    let selectedProxies = new Set();
    let allProxies = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadAllProxies();
        loadProxyConfig();
    });
    
    // ========== ä»£ç†é…ç½®ç®¡ç†åŠŸèƒ½ ==========
    
    // åŠ è½½ä»£ç†é…ç½®çŠ¶æ€
    async function loadProxyConfig() {
        try {
            const response = await fetch('/admin/api/proxy-config', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateProxyStatusUI(data.config, data.active_proxy);
            } else {
                console.error('åŠ è½½ä»£ç†é…ç½®å¤±è´¥:', data.message);
            }
        } catch (error) {
            console.error('åŠ è½½ä»£ç†é…ç½®å¤±è´¥:', error);
        }
    }
    
    // æ›´æ–°ä»£ç†çŠ¶æ€UI
    function updateProxyStatusUI(config, activeProxy) {
        const statusPanel = document.getElementById('proxyStatusPanel');
        const statusIcon = document.getElementById('proxyStatusIcon');
        const statusText = document.getElementById('proxyStatusText');
        const statusDetails = document.getElementById('proxyStatusDetails');
        const enableBtn = document.getElementById('enableProxyBtn');
        const disableBtn = document.getElementById('disableProxyBtn');
        
        const proxyEnabled = config.proxy_enabled === '1';
        
        if (proxyEnabled && activeProxy) {
            // ä»£ç†å·²å¯ç”¨
            statusPanel.style.display = 'block';
            statusPanel.style.background = '#d4edda';
            statusIcon.textContent = 'ğŸŸ¢';
            statusText.textContent = 'å·²å¯ç”¨';
            statusText.style.color = '#155724';
            statusDetails.innerHTML = `
                å½“å‰ä»£ç†: <strong>${activeProxy.proxy_type.toUpperCase()}--${activeProxy.name || ''}--åœ°å€: ${activeProxy.host}:${activeProxy.port}</strong>
            `;
            statusDetails.style.color = '#155724';
            
            enableBtn.style.display = 'none';
            disableBtn.style.display = 'inline-block';
        } else if (proxyEnabled) {
            // ä»£ç†å·²å¯ç”¨ä½†æ— æœ‰æ•ˆä»£ç†
            statusPanel.style.display = 'block';
            statusPanel.style.background = '#fff3cd';
            statusIcon.textContent = 'âš ï¸';
            statusText.textContent = 'é…ç½®å¼‚å¸¸';
            statusText.style.color = '#856404';
            statusDetails.textContent = 'ä»£ç†å·²å¯ç”¨ä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä»£ç†é…ç½®';
            statusDetails.style.color = '#856404';
            
            enableBtn.style.display = 'inline-block';
            disableBtn.style.display = 'inline-block';
        } else {
            // ä»£ç†æœªå¯ç”¨
            statusPanel.style.display = 'block';
            statusPanel.style.background = '#f8f9fa';
            statusIcon.textContent = 'âšª';
            statusText.textContent = 'æœªå¯ç”¨';
            statusText.style.color = '#6b7280';
            statusDetails.textContent = 'ç‚¹å‡»"å¼€å¯ä»£ç†"æŒ‰é’®æ™ºèƒ½é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„ä»£ç†ï¼Œæˆ–æ‰‹åŠ¨åˆ‡æ¢åˆ°æŒ‡å®šä»£ç†';
            statusDetails.style.color = '#6b7280';
            
            enableBtn.style.display = 'inline-block';
            disableBtn.style.display = 'none';
        }
    }
    
    // å¼€å¯ä»£ç†
    async function enableProxy() {
        try {
            showToast('æ­£åœ¨å¼€å¯ä»£ç†...', 'info', 1000);
            
            const response = await fetch('/admin/api/proxy-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'enable_proxy' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                loadProxyConfig();
                loadAllProxies();
            } else {
                showToast(data.message || 'å¼€å¯ä»£ç†å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('å¼€å¯ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // å…³é—­ä»£ç†
    async function disableProxy() {
        if (!confirm('ç¡®å®šè¦å…³é—­ä»£ç†åŠŸèƒ½å—ï¼Ÿ')) {
            return;
        }
        
        try {
            showToast('æ­£åœ¨å…³é—­ä»£ç†...', 'info', 1000);
            
            const response = await fetch('/admin/api/proxy-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'disable_proxy' })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                loadProxyConfig();
                loadAllProxies();
            } else {
                showToast(data.message || 'å…³é—­ä»£ç†å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('å…³é—­ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // åˆ‡æ¢ä»£ç†
    async function switchProxy(type, id, name) {
        if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°ä»£ç† "${name}" å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            showToast('æ­£åœ¨åˆ‡æ¢ä»£ç†...', 'info', 1000);
            
            const response = await fetch('/admin/api/proxy-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'switch_proxy',
                    proxy_type: type,
                    proxy_id: id
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                loadProxyConfig();
                loadAllProxies();
            } else {
                showToast(data.message || 'åˆ‡æ¢ä»£ç†å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åˆ‡æ¢ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== ç»Ÿä¸€ä»£ç†ç®¡ç†åŠŸèƒ½ ==========
    
    // åŠ è½½æ‰€æœ‰ä»£ç†åˆ—è¡¨ï¼ˆHTTP + SOCKS5ï¼‰
    async function loadAllProxies(page = null, search = null) {
        try {
            if (page !== null) currentPage = page;
            if (search !== null) searchQuery = search;
            
            // å¹¶è¡ŒåŠ è½½HTTPå’ŒSOCKS5ä»£ç†
            const [httpResponse, socks5Response] = await Promise.all([
                fetch(`/admin/api/proxies/http?page=1&per_page=1000&search=${searchQuery}`),
                fetch(`/admin/api/proxies/socks5?page=1&per_page=1000&search=${searchQuery}`)
            ]);
            
            const httpData = await httpResponse.json();
            const socks5Data = await socks5Response.json();
            
            if (httpData.success && socks5Data.success) {
                // åˆå¹¶ä»£ç†æ•°æ®ï¼Œæ·»åŠ ç±»å‹æ ‡è¯†
                allProxies = [
                    ...httpData.data.map(proxy => ({ ...proxy, proxy_type: 'HTTP' })),
                    ...socks5Data.data.map(proxy => ({ ...proxy, proxy_type: 'SOCKS5' }))
                ];
                
                // æŒ‰unified_idæ’åºï¼Œç¡®ä¿æ˜¾ç¤ºé¡ºåºä¸º1-2-3-4è€Œä¸æ˜¯1-3-2-4
                allProxies.sort((a, b) => {
                    // é¦–å…ˆæŒ‰unified_idæ’åºï¼Œå¦‚æœunified_idä¸º0åˆ™ä½¿ç”¨æ•°æ®åº“ID
                    const aId = a.unified_id && a.unified_id > 0 ? a.unified_id : a.id;
                    const bId = b.unified_id && b.unified_id > 0 ? b.unified_id : b.id;
                    return aId - bId;
                });
                
                renderUnifiedProxyTable();
                renderUnifiedPagination();
            } else {
                showToast('åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æ¸²æŸ“ç»Ÿä¸€ä»£ç†è¡¨æ ¼
    function renderUnifiedProxyTable() {
        const tbody = document.querySelector('#proxyTable tbody');
        tbody.innerHTML = '';
        
        // åˆ†é¡µå¤„ç†
        const startIndex = (currentPage - 1) * perPage;
        const endIndex = startIndex + perPage;
        const paginatedProxies = allProxies.slice(startIndex, endIndex);
        
        if (paginatedProxies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: #6b7280;">æš‚æ— ä»£ç†é…ç½®</td></tr>';
            return;
        }
        
        paginatedProxies.forEach((proxy, index) => {
            const row = document.createElement('tr');
            const statusBadge = getStatusBadge(proxy.status, proxy.response_time);
            const proxyType = proxy.proxy_type.toLowerCase();
            
            // ä½¿ç”¨ç»Ÿä¸€IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™æ˜¾ç¤ºæ•°æ®åº“ID
            const unifiedId = proxy.unified_id && proxy.unified_id > 0 ? proxy.unified_id : proxy.id;
            
            row.innerHTML = `
                <td><input type="checkbox" class="proxy-checkbox" value="${proxyType}-${proxy.id}" onchange="toggleProxySelection('${proxyType}', ${proxy.id})"></td>
                <td><strong>${unifiedId}</strong></td>
                <td><span style="background: ${proxyType === 'http' ? '#dbeafe' : '#fef3c7'}; color: ${proxyType === 'http' ? '#1e40af' : '#92400e'}; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 500;">${proxy.proxy_type}</span></td>
                <td>${escapeHtml(proxy.name) || ''}</td>
                <td>${escapeHtml(proxy.host)}:${proxy.port}</td>
                <td>${escapeHtml(proxy.username || '-')}</td>
                <td>${proxy.password ? '******' : '-'}</td>
                <td>${statusBadge}</td>
                <td>${proxy.response_time ? proxy.response_time + 'ms' : '-'}</td>
                <td>${formatDateTime(proxy.last_check)}</td>
                <td>${escapeHtml(proxy.remarks || '-')}</td>
                <td>
                    <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-small" onclick="switchProxy('${proxyType}', ${proxy.id}, '${escapeHtml(proxy.name) || ''}')" title="åˆ‡æ¢åˆ°æ­¤ä»£ç†">åˆ‡æ¢</button>
                        <button class="btn btn-success btn-small" onclick="editProxy('${proxyType}', ${proxy.id})">ç¼–è¾‘</button>
                        <button class="btn btn-warning btn-small" onclick="testSingleProxy('${proxyType}', ${proxy.id})">æµ‹è¯•</button>
                        <button class="btn btn-danger btn-small" onclick="deleteProxy('${proxyType}', ${proxy.id})">åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        updateBatchDeleteButton();
    }
    
    // æ¸²æŸ“ç»Ÿä¸€åˆ†é¡µ
    function renderUnifiedPagination() {
        const container = document.getElementById('proxyPaginationContainer');
        const total = allProxies.length;
        totalPages = Math.ceil(total / perPage);
        
        let html = `<div class="pagination-info">å…± ${total} æ¡è®°å½•ï¼Œç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</div>`;
        
        if (totalPages > 1) {
            html += '<div class="pagination-buttons">';
            
            // ä¸Šä¸€é¡µ
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="loadAllProxies(${currentPage - 1})">Â« ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="loadAllProxies(1)">1</button>`;
                if (startPage > 2) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadAllProxies(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
                html += `<button class="page-btn" onclick="loadAllProxies(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="loadAllProxies(${currentPage + 1})">ä¸‹ä¸€é¡µ Â»</button>`;
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
    }
    
    // åŠ è½½ä»£ç†åˆ—è¡¨
    async function loadProxies(type, page = null, search = null) {
        try {
            if (page !== null) currentPages[type] = page;
            if (search !== null) searchQueries[type] = search;
            
            const params = new URLSearchParams({
                page: currentPages[type],
                per_page: perPages[type],
                search: searchQueries[type]
            });
            
            const response = await fetch(`/admin/api/proxies/${type}?${params}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                renderProxyTable(type, data.data);
                renderProxyPagination(type, data.pagination);
            } else {
                showToast(`åŠ è½½${type.toUpperCase()}ä»£ç†åˆ—è¡¨å¤±è´¥`, 'error');
            }
        } catch (error) {
            console.error(`åŠ è½½${type}ä»£ç†åˆ—è¡¨å¤±è´¥:`, error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æ¸²æŸ“ä»£ç†è¡¨æ ¼
    function renderProxyTable(type, proxies) {
        const tbody = document.querySelector(`#${type}ProxyTable tbody`);
        tbody.innerHTML = '';
        
        if (proxies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: #6b7280;">æš‚æ— ä»£ç†é…ç½®</td></tr>';
            return;
        }
        
        proxies.forEach(proxy => {
            const row = document.createElement('tr');
            const statusBadge = getStatusBadge(proxy.status, proxy.response_time);
            
            row.innerHTML = `
                <td><input type="checkbox" class="${type}-proxy-checkbox" value="${proxy.id}" onchange="toggleProxySelection('${type}', ${proxy.id})"></td>
                <td>${proxy.id}</td>
                <td>${type.toUpperCase()}</td>
                <td>${escapeHtml(proxy.name)}</td>
                <td>${escapeHtml(proxy.host)}:${proxy.port}</td>
                <td>${escapeHtml(proxy.username || '-')}</td>
                <td>${proxy.password ? '******' : '-'}</td>
                <td>${statusBadge}</td>
                <td>${proxy.response_time ? proxy.response_time + 'ms' : '-'}</td>
                <td>${formatDateTime(proxy.last_check)}</td>
                <td>${escapeHtml(proxy.remarks || '-')}</td>
                <td>
                    <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-small" onclick="editProxy('${type}', ${proxy.id})">ç¼–è¾‘</button>
                        <button class="btn btn-warning btn-small" onclick="testSingleProxy('${type}', ${proxy.id})">æµ‹è¯•</button>
                        <button class="btn btn-danger btn-small" onclick="deleteProxy('${type}', ${proxy.id})">åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        updateBatchDeleteButton();
    }
    
    // è·å–çŠ¶æ€å¾½ç« 
    function getStatusBadge(status, responseTime) {
        if (status === 1) {
            const timeColor = responseTime < 500 ? 'online' : 'testing';
            return `<span class="status-badge ${timeColor}">åœ¨çº¿</span>`;
        } else {
            return '<span class="status-badge offline">ç¦»çº¿</span>';
        }
    }
    
    // æ¸²æŸ“ä»£ç†åˆ†é¡µ
    function renderProxyPagination(type, pagination) {
        const container = document.getElementById(`${type}PaginationContainer`);
        totalPages[type] = pagination.pages;
        
        let html = `<div class="pagination-info">å…± ${pagination.total} æ¡è®°å½•ï¼Œç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.pages} é¡µ</div>`;
        
        if (pagination.pages > 1) {
            html += '<div class="pagination-buttons">';
            
            // ä¸Šä¸€é¡µ
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="loadProxies('${type}', ${pagination.page - 1})">Â« ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.pages, pagination.page + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="loadProxies('${type}', 1)">1</button>`;
                if (startPage > 2) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadProxies('${type}', ${i})">${i}</button>`;
            }
            
            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
                html += `<button class="page-btn" onclick="loadProxies('${type}', ${pagination.pages})">${pagination.pages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="loadProxies('${type}', ${pagination.page + 1})">ä¸‹ä¸€é¡µ Â»</button>`;
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
    }
    
    // æ¸…é™¤ä»£ç†æœç´¢
    function clearProxySearch() {
        document.getElementById('proxySearchInput').value = '';
        loadAllProxies(1, '');
    }
    
    // æœç´¢ä»£ç†
    function searchProxies() {
        const search = document.getElementById('proxySearchInput').value.trim();
        loadAllProxies(1, search);
    }
    
    // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
    function changePerPage() {
        perPage = parseInt(document.getElementById('proxyPerPageSelect').value);
        loadAllProxies(1, searchQuery);
    }
    
    // æ˜¾ç¤ºæ·»åŠ ä»£ç†æ¨¡æ€æ¡†
    function showAddProxyModal(type) {
        document.getElementById('proxyModalTitle').textContent = `æ·»åŠ ${type.toUpperCase()}ä»£ç†`;
        document.getElementById('proxyAction').value = 'add';
        document.getElementById('proxyType').value = type;
        document.getElementById('proxyForm').reset();
        document.getElementById('proxyId').value = '';
        document.getElementById('proxyModal').classList.add('show');
    }
    
    // ç¼–è¾‘ä»£ç†
    async function editProxy(type, id) {
        try {
            const response = await fetch(`/admin/api/proxies/${type}`);
            const data = await response.json();
            
            if (data.success) {
                const proxy = data.data.find(p => p.id === id);
                if (proxy) {
                    document.getElementById('proxyModalTitle').textContent = `ç¼–è¾‘${type.toUpperCase()}ä»£ç†`;
                    document.getElementById('proxyAction').value = 'edit';
                    document.getElementById('proxyType').value = type;
                    document.getElementById('proxyId').value = proxy.id;
                    document.getElementById('proxyName').value = proxy.name;
                    document.getElementById('proxyHost').value = proxy.host;
                    document.getElementById('proxyPort').value = proxy.port;
                    document.getElementById('proxyUsername').value = proxy.username || '';
                    document.getElementById('proxyPassword').value = proxy.password || '';
                    document.getElementById('proxyRemarks').value = proxy.remarks || '';
                    document.getElementById('proxyModal').classList.add('show');
                }
            }
        } catch (error) {
            console.error('è·å–ä»£ç†ä¿¡æ¯å¤±è´¥:', error);
            showToast('è·å–ä»£ç†ä¿¡æ¯å¤±è´¥', 'error');
        }
    }
    
    // æµ‹è¯•å•ä¸ªä»£ç†
    async function testSingleProxy(type, id) {
        try {
            showToast('ä»£ç†æµ‹è¯•ä¸­ï¼Œè¯·ç¨å€™...', 'info', 1000);
            
            const response = await fetch(`/admin/api/proxies/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'test',
                    id: parseInt(id)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const details = data.details;
                let message = data.message;
                
                if (details && details.results) {
                    const results = details.results;
                    const successCount = results.filter(r => r.success).length;
                    message += `\næµ‹è¯•ç»“æœï¼š${successCount}/${results.length} æˆåŠŸ`;
                    
                    results.forEach(result => {
                        if (result.success) {
                            message += `\nâœ… ${result.url}: ${result.response_time}ms`;
                        } else {
                            message += `\nâŒ ${result.url}: æµ‹è¯•å¤±è´¥`;
                        }
                    });
                }
                
                showToast(message, 'success', 5000);
                loadAllProxies(currentPage, searchQuery);
            } else {
                showToast(data.message || 'ä»£ç†æµ‹è¯•å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æµ‹è¯•ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æµ‹è¯•ä»£ç†ï¼ˆåœ¨æ¨¡æ€æ¡†ä¸­ï¼‰
    async function testProxy() {
        const proxyId = document.getElementById('proxyId').value;
        const proxyType = document.getElementById('proxyType').value;
        
        if (proxyId) {
            // å¦‚æœæœ‰IDï¼Œæµ‹è¯•å·²ä¿å­˜çš„ä»£ç†
            await testSingleProxy(proxyType, proxyId);
        } else {
            // å¦‚æœæ²¡æœ‰IDï¼Œæµ‹è¯•è¡¨å•ä¸­çš„æ•°æ®ï¼ˆæ— éœ€ä¿å­˜ï¼‰
            await testNewProxy();
        }
    }
    
    // æµ‹è¯•æ–°ä»£ç†ï¼ˆæ— éœ€ä¿å­˜ï¼‰
    async function testNewProxy() {
        const form = document.getElementById('proxyForm');
        const formData = new FormData(form);
        const proxyType = formData.get('type');
        
        const data = {
            action: 'test_new',
            host: formData.get('host'),
            port: parseInt(formData.get('port')),
            username: formData.get('username'),
            password: formData.get('password'),
            name: formData.get('name')
        };
        
        // åŸºç¡€éªŒè¯
        if (!data.host || !data.port) {
            showToast('è¯·å¡«å†™ä»£ç†åœ°å€å’Œç«¯å£', 'error');
            return;
        }
        
        try {
            showToast('ä»£ç†æµ‹è¯•ä¸­ï¼Œè¯·ç¨å€™...', 'info', 1000);
            
            const response = await fetch(`/admin/api/proxies/${proxyType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                const details = result.details;
                let message = result.message;
                
                if (details && details.results) {
                    const results = details.results;
                    const successCount = results.filter(r => r.success).length;
                    message += `\næµ‹è¯•ç»“æœï¼š${successCount}/${results.length} æˆåŠŸ`;
                    
                    results.forEach(result => {
                        if (result.success) {
                            message += `\nâœ… ${result.url}: ${result.response_time}ms`;
                        } else {
                            message += `\nâŒ ${result.url}: æµ‹è¯•å¤±è´¥`;
                        }
                    });
                }
                
                showToast(message, 'success', 5000);
            } else {
                showToast(result.message || 'ä»£ç†æµ‹è¯•å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æµ‹è¯•ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // åˆ é™¤ä»£ç†
    async function deleteProxy(type, id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†é…ç½®å—ï¼Ÿ')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/proxies/${type}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: id })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('ä»£ç†åˆ é™¤æˆåŠŸ', 'success');
                loadAllProxies(currentPage, searchQuery);
            } else {
                showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åˆ é™¤ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ä¿å­˜ä»£ç†
    async function saveProxy() {
        const form = document.getElementById('proxyForm');
        const formData = new FormData(form);
        const type = formData.get('type');
        
        const data = {
            action: formData.get('action'),
            name: formData.get('name'),
            host: formData.get('host'),
            port: parseInt(formData.get('port')),
            username: formData.get('username'),
            password: formData.get('password'),
            remarks: formData.get('remarks')
        };
        
        if (data.action === 'edit') {
            data.id = parseInt(formData.get('id'));
        }
        
        try {
            const response = await fetch(`/admin/api/proxies/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'ä¿å­˜æˆåŠŸ', 'success');
                closeProxyModal();
                loadAllProxies(currentPage, searchQuery);
            } else {
                showToast(result.message || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('ä¿å­˜ä»£ç†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== é€‰æ‹©ç®¡ç†åŠŸèƒ½ ==========
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('proxySelectAll');
        const checkboxes = document.querySelectorAll('.proxy-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            const [type, id] = checkbox.value.split('-');
            if (selectAll.checked) {
                selectedProxies.add(checkbox.value);
            } else {
                selectedProxies.delete(checkbox.value);
            }
        });
        
        updateBatchDeleteButton();
    }
    
    // åˆ‡æ¢ä»£ç†é€‰æ‹©çŠ¶æ€
    function toggleProxySelection(type, id) {
        const key = `${type}-${id}`;
        if (selectedProxies.has(key)) {
            selectedProxies.delete(key);
        } else {
            selectedProxies.add(key);
        }
        updateBatchDeleteButton();
    }
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        const btn = document.getElementById('batchDeleteBtn');
        const selectedCount = selectedProxies.size;
        
        if (selectedCount > 0) {
            btn.style.display = 'inline-block';
            btn.textContent = `ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (${selectedCount})`;
        } else {
            btn.style.display = 'none';
        }
    }
    
    // æ‰¹é‡åˆ é™¤ä»£ç†
    async function batchDeleteProxies() {
        if (selectedProxies.size === 0) {
            showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„ä»£ç†', 'error');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedProxies.size} ä¸ªä»£ç†å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            // æŒ‰ç±»å‹åˆ†ç»„é€‰ä¸­çš„ä»£ç†
            const httpIds = [];
            const socks5Ids = [];
            
            selectedProxies.forEach(key => {
                const [type, id] = key.split('-');
                if (type === 'http') {
                    httpIds.push(parseInt(id));
                } else if (type === 'socks5') {
                    socks5Ids.push(parseInt(id));
                }
            });
            
            // å¹¶è¡Œåˆ é™¤
            const promises = [];
            if (httpIds.length > 0) {
                promises.push(
                    fetch('/admin/api/proxies/http', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'batch_delete', ids: httpIds })
                    })
                );
            }
            if (socks5Ids.length > 0) {
                promises.push(
                    fetch('/admin/api/proxies/socks5', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'batch_delete', ids: socks5Ids })
                    })
                );
            }
            
            const responses = await Promise.all(promises);
            const results = await Promise.all(responses.map(r => r.json()));
            
            const allSuccess = results.every(r => r.success);
            
            if (allSuccess) {
                showToast(`æ‰¹é‡åˆ é™¤æˆåŠŸ`, 'success');
                selectedProxies.clear();
                loadAllProxies(currentPage, searchQuery);
            } else {
                showToast('éƒ¨åˆ†åˆ é™¤å¤±è´¥', 'error');
                loadAllProxies(currentPage, searchQuery);
            }
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== æ¨¡æ€æ¡†ç®¡ç† ==========
    
    // å…³é—­ä»£ç†æ¨¡æ€æ¡†
    function closeProxyModal() {
        document.getElementById('proxyModal').classList.remove('show');
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('proxyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeProxyModal();
        }
    });
    
    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeProxyModal();
        }
        
        if (e.key === 'Enter') {
            const activeInput = document.activeElement;
            if (activeInput && activeInput.id === 'proxySearchInput') {
                searchProxies();
            }
        }
    });
    
    // ========== å·¥å…·å‡½æ•° ==========
    
    // Toasté€šçŸ¥ç³»ç»Ÿ
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // å¤„ç†å¤šè¡Œæ¶ˆæ¯
        if (message.includes('\n')) {
            const lines = message.split('\n');
            toast.innerHTML = lines.map(line => `<div>${escapeHtml(line)}</div>`).join('');
        } else {
            toast.textContent = message;
        }
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleString('zh-CN');
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šé˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šèŠ‚æµå‡½æ•°  
    function throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡DOMæ“ä½œ
    function batchDOMUpdate(callback) {
        requestAnimationFrame(() => {
            callback();
        });
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜DOMå…ƒç´ 
    const cachedElements = new Map();
    function getCachedElement(id) {
        if (!cachedElements.has(id)) {
            cachedElements.set(id, document.getElementById(id));
        }
        return cachedElements.get(id);
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šä¼˜åŒ–æœç´¢åŠŸèƒ½
    const optimizedSearch = debounce(function(query) {
        searchQuery = query;
        currentPage = 1;
        loadProxies(currentProxyType);
    }, 300);
    
    // ç»‘å®šæœç´¢ä¼˜åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                optimizedSearch(e.target.value);
            });
        }
    });
    
</script>
{% endblock %}