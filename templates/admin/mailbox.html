{% extends "base.html" %}

{% block title %}é‚®ç®±ç®¡ç† - {{ system_title }}{% endblock %}

{% block head %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --sidebar-width: 280px;
        --header-height: 70px;
        --transition: all 0.3s ease;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        line-height: 1.6;
        color: #334155;
        transition: var(--transition);
    }
    
    /* Sidebar Styles */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        z-index: 1000;
        transition: var(--transition);
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-logo {
        color: white;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        padding: 20px 0;
    }
    
    .nav-item {
        display: block;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        padding: 15px 25px;
        transition: var(--transition);
        border-left: 3px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.1);
        transform: translateX(-100%);
        transition: var(--transition);
    }
    
    .nav-item:hover::before {
        transform: translateX(0);
    }
    
    .nav-item:hover,
    .nav-item.active {
        color: white;
        background: rgba(255,255,255,0.15);
        border-left-color: white;
        transform: translateX(5px);
    }
    
    .nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Main Content */
    .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        transition: var(--transition);
    }
    
    .header {
        background: white;
        height: var(--header-height);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 999;
    }
    
    .header-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #64748b;
    }
    
    .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
    }
    
    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    /* Content Area */
    .content {
        padding: 30px;
    }
    
    /* Cards */
    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 25px;
        transition: var(--transition);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
    }
    
    .card-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .card-body {
        padding: 25px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
    }
    
    /* Table Styles */
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    table th,
    table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    
    table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
    }
    
    table tr:hover {
        background: #f8fafc;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideInUp 0.3s ease;
    }
    
    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
    }
    
    .modal-close:hover {
        color: #374151;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }
    
    .toast {
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transform: translateX(450px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }
    
    .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .toast.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    /* å¢å¼ºæ ·å¼ */
    .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .search-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: nowrap; /* Prevent wrapping unless specifically needed */
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 600px; /* Increased from 400px for longer search box */
        min-width: 0; /* Allow shrinking */
    }
    
    .search-box input {
        flex: 1;
        min-width: 250px; /* Increased from 150px for better appearance */
        padding: 10px 16px; /* Enhanced padding for better visual appeal */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .search-box input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }
    
    .page-controls select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .pagination-info {
        color: #6b7280;
        font-size: 14px;
        margin-right: 20px;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #374151;
        text-decoration: none;
        border-radius: 6px;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .page-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .server-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .server-item {
        padding: 10px 15px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .server-item:hover {
        background: #f8fafc;
    }
    
    .server-item:last-child {
        border-bottom: none;
    }
    
    .server-info {
        flex: 1;
    }
    
    .server-id {
        font-size: 11px;
        color: #9ca3af;
        font-weight: 500;
    }
    
    .server-name {
        font-weight: 500;
        color: #1e293b;
    }
    
    .server-address {
        font-size: 12px;
        color: #6b7280;
    }
    
    .server-actions {
        display: flex;
        gap: 5px;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
    }
    
    /* Mobile menu toggle - default hidden */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
        transition: var(--transition);
    }
    
    .mobile-menu-toggle:hover {
        color: var(--primary-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .header-title {
            font-size: 20px;
        }
        
        .content {
            padding: 20px;
        }
        
        .mobile-menu-toggle {
            display: block !important;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .search-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            max-width: none;
        }
        
        .form-row {
            flex-direction: column;
        }
        
        .pagination-container {
            flex-wrap: wrap;
            gap: 5px;
        }
    }
    
    /* Mobile overlay */
    .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    
    .mobile-overlay.show {
        display: block;
    }
</style>
{% endblock %}

{% block body %}
<!-- Toast notification container -->
<div id="toast-container" class="toast-container"></div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“§ é‚®ä»¶ç®¡ç†ç³»ç»Ÿ</div>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('admin_home') }}" class="nav-item">
            <i>ğŸ </i> é¦–é¡µ
        </a>
        <a href="{{ url_for('admin_mailbox') }}" class="nav-item active">
            <i>ğŸ“«</i> é‚®ç®±ç®¡ç†
        </a>
        <a href="{{ url_for('admin_daili') }}" class="nav-item">
            <i>ğŸŒ</i> ä»£ç†æ± 
        </a>
        <a href="{{ url_for('admin_kami') }}" class="nav-item">
            <i>ğŸ”‘</i> å¡å¯†ç®¡ç†
        </a>
        <a href="{{ url_for('admin_kamirizhi') }}" class="nav-item">
            <i>ğŸ“</i> å¡å¯†æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_shoujian') }}" class="nav-item">
            <i>ğŸ“§</i> æ”¶ä»¶æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_system') }}" class="nav-item">
            <i>âš™ï¸</i> ç³»ç»Ÿè®¾ç½®
        </a>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
            <h1 class="header-title">é‚®ç®±ç®¡ç†</h1>
        </div>
        <div class="header-actions">
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ{{ admin_username }}</span>
            </div>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </div>
    
    <div class="content">
        <!-- å·¦ä¾§æ“ä½œæŒ‰é’® -->
        <div class="card" style="margin-bottom: 15px;">
            <div class="card-body" style="padding: 20px;">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="showAddModal()">
                        â• æ·»åŠ é‚®ç®±
                    </button>
                    <button class="btn btn-primary" onclick="showBatchAddModal()">
                        ğŸ“ æ‰¹é‡æ·»åŠ é‚®ç®±
                    </button>
                    <button class="btn btn-primary" onclick="showServerModal()">
                        ğŸŒ æ·»åŠ æœåŠ¡å™¨åœ°å€
                    </button>
                    <button class="btn btn-danger" onclick="batchDeleteMailboxes()" id="batchDeleteBtn" style="display: none;">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">é‚®ç®±è´¦å·ç®¡ç†</h2>
            </div>
            <div class="card-body">
                <!-- æœç´¢å’Œåˆ†é¡µæ§åˆ¶ -->
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="æœç´¢é‚®ç®±åœ°å€ã€æœåŠ¡å™¨æˆ–å¤‡æ³¨..." onkeyup="searchMailboxes()">
                        <button class="btn btn-primary" onclick="searchMailboxes()">ğŸ” æœç´¢</button>
                        <button class="btn btn-danger" onclick="clearMailboxSearch()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="page-controls">
                        <select id="perPageSelect" onchange="changePerPage()">
                            <option value="10">æ¯é¡µ10æ¡</option>
                            <option value="20">æ¯é¡µ20æ¡</option>
                            <option value="50">æ¯é¡µ50æ¡</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="mailboxTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>åºå·ID</th>
                                <th>é‚®ç®±åœ°å€</th>
                                <th>é‚®ç®±å¯†ç </th>
                                <th>æœåŠ¡å™¨</th>
                                <th>ç«¯å£/åè®®</th>
                                <th>SSL</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ·»åŠ æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é‚®ç®±åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ è½½ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µå¯¼èˆª -->
                <div class="pagination-container" id="paginationContainer">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘é‚®ç®±æ¨¡æ€æ¡† -->
<div id="mailboxModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">æ·»åŠ é‚®ç®±</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="mailboxForm">
                <input type="hidden" id="mailboxId" name="id">
                <input type="hidden" id="formAction" name="action" value="add">
                
                <!-- é‚®ç®±è´¦å·å’Œé‚®ç®±å¯†ç åŒä¸€è¡Œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">é‚®ç®±è´¦å· *</label>
                        <input type="email" id="email" name="email" required placeholder="ä¾‹: user@example.com">
                    </div>
                    <div class="form-group">
                        <label for="password">é‚®ç®±å¯†ç  *</label>
                        <input type="password" id="password" name="password" required placeholder="é‚®ç®±å¯†ç æˆ–æˆæƒç ">
                    </div>
                </div>
                
                <!-- æœåŠ¡å™¨åœ°å€å’Œé€‰æ‹©æœåŠ¡å™¨åŒä¸€è¡Œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="server">æœåŠ¡å™¨åœ°å€ *</label>
                        <input type="text" id="server" name="server" required 
                               placeholder="ä¾‹: imap.qq.com">
                    </div>
                    <div class="form-group">
                        <label for="serverSelect">é€‰æ‹©æœåŠ¡å™¨</label>
                        <select id="serverSelect" onchange="selectServer()">
                            <option value="">é€‰æ‹©å·²æœ‰æœåŠ¡å™¨æˆ–æ‰‹åŠ¨è¾“å…¥</option>
                        </select>
                    </div>
                </div>
                
                <!-- åè®®å’Œç«¯å£åŒä¸€è¡Œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="protocol">åè®® *</label>
                        <select id="protocol" name="protocol" onchange="updatePortByProtocol()">
                            <option value="imap">IMAP</option>
                            <option value="pop3">POP3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="port">ç«¯å£ *</label>
                        <input type="number" id="port" name="port" required 
                               placeholder="ä¾‹: 993">
                    </div>
                </div>
                
                <!-- å¯ç”¨SSLå•ç‹¬ä¸€è¡Œ -->
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="ssl" name="ssl" checked onchange="updatePortBySSL()">
                        <label for="ssl">å¯ç”¨SSL</label>
                    </div>
                </div>
                
                <!-- å¤‡æ³¨å•ç‹¬ä¸€è¡Œ -->
                <div class="form-group">
                    <label for="remarks">å¤‡æ³¨</label>
                    <input type="text" id="remarks" name="remarks" 
                           placeholder="å¯é€‰ï¼šå¤‡æ³¨ä¿¡æ¯">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-success" onclick="testMailbox()" id="testBtn" style="display: none;">æµ‹è¯•é‚®ç®±</button>
            <button type="button" class="btn btn-primary" onclick="saveMailbox()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ·»åŠ é‚®ç®±æ¨¡æ€æ¡† -->
<div id="batchAddModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">æ‰¹é‡æ·»åŠ é‚®ç®±</h3>
            <button class="modal-close" onclick="closeBatchAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="batchAddForm">
                <!-- æ‰¹é‡é‚®ç®±å†…å®¹ä¸€è¡Œ -->
                <div class="form-group">
                    <label for="batchContent">æ‰¹é‡é‚®ç®±å†…å®¹ *</label>
                    <textarea id="batchContent" name="batch_content" rows="10" 
                              placeholder="æ ¼å¼ï¼šè´¦å·----å¯†ç ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰&#10;ä¾‹å¦‚ï¼š&#10;user1@example.com----password1&#10;user2@example.com----password2"
                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace;"></textarea>
                    <small style="color: #6b7280;">è¯·æŒ‰ç…§"è´¦å·----å¯†ç "çš„æ ¼å¼å¡«å†™ï¼Œæ¯è¡Œä¸€ä¸ªè´¦å·</small>
                </div>
                
                <!-- æœåŠ¡å™¨åœ°å€å’Œé€‰æ‹©æœåŠ¡å™¨ä¸€è¡Œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="batchServer">æœåŠ¡å™¨åœ°å€ *</label>
                        <input type="text" id="batchServer" name="server" required 
                               placeholder="ä¾‹: imap.qq.com">
                    </div>
                    <div class="form-group">
                        <label for="batchServerSelect">é€‰æ‹©æœåŠ¡å™¨</label>
                        <select id="batchServerSelect" onchange="selectBatchServer()">
                            <option value="">é€‰æ‹©å·²æœ‰æœåŠ¡å™¨æˆ–æ‰‹åŠ¨è¾“å…¥</option>
                        </select>
                    </div>
                </div>
                
                <!-- åè®®å’Œç«¯å£ä¸€è¡Œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="batchProtocol">åè®® *</label>
                        <select id="batchProtocol" name="protocol" onchange="updateBatchPortByProtocol()">
                            <option value="imap">IMAP</option>
                            <option value="pop3">POP3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="batchPort">ç«¯å£ *</label>
                        <input type="number" id="batchPort" name="port" required 
                               placeholder="ä¾‹: 993">
                    </div>
                </div>
                
                <!-- å¯ç”¨SSLå•ç‹¬ä¸€è¡Œ -->
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="batchSsl" name="ssl" checked onchange="updateBatchPortBySSL()">
                        <label for="batchSsl">å¯ç”¨SSL</label>
                    </div>
                </div>
                
                <!-- å¤‡æ³¨å•ç‹¬ä¸€è¡Œ -->
                <div class="form-group">
                    <label for="batchRemarks">å¤‡æ³¨</label>
                    <input type="text" id="batchRemarks" name="remarks" 
                           placeholder="å¯é€‰ï¼šæ‰¹é‡æ·»åŠ å¤‡æ³¨">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeBatchAddModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveBatchMailboxes()">æ‰¹é‡æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- æœåŠ¡å™¨ç®¡ç†æ¨¡æ€æ¡† -->
<div id="serverModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">æœåŠ¡å™¨åœ°å€ç®¡ç†</h3>
            <button class="modal-close" onclick="closeServerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- æ·»åŠ æœåŠ¡å™¨è¡¨å• -->
            <form id="serverForm">
                <input type="hidden" id="serverId" name="id">
                <input type="hidden" id="serverAction" name="action" value="add">
                
                <!-- ä»…ä¿ç•™ä¸Šæ–¹ï¼šæœåŠ¡å™¨åç§°ã€æœåŠ¡å™¨åœ°å€ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="serverName">æœåŠ¡å™¨åç§° *</label>
                        <input type="text" id="serverName" name="server_name" required 
                               placeholder="ä¾‹: QQé‚®ç®±">
                    </div>
                    
                    <div class="form-group">
                        <label for="serverAddress">æœåŠ¡å™¨åœ°å€ *</label>
                        <input type="text" id="serverAddress" name="server_address" required 
                               placeholder="ä¾‹: imap.qq.com">
                    </div>
                </div>
                
                <!-- éšè—å­—æ®µä¿æŒé»˜è®¤å€¼ -->
                <input type="hidden" id="defaultPortImap" name="default_port_imap" value="993">
                <input type="hidden" id="defaultPortPop3" name="default_port_pop3" value="995">
                <input type="hidden" id="serverSslEnabled" name="ssl_enabled" value="true">
                <input type="hidden" id="serverRemarks" name="remarks" value="">
                
                <div style="text-align: right; margin-top: 15px;">
                    <button type="button" class="btn btn-primary" onclick="saveServer()">
                        <span id="serverSaveText">æ·»åŠ æœåŠ¡å™¨</span>
                    </button>
                </div>
            </form>
            
            <!-- å·²æ·»åŠ æœåŠ¡å™¨åˆ—è¡¨ -->
            <div style="margin-top: 25px;">
                <h4 style="margin-bottom: 15px; color: #374151;">å·²æ·»åŠ çš„æœåŠ¡å™¨</h4>
                <div class="server-list" id="serverList">
                    <!-- æœåŠ¡å™¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ è½½ -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-danger" onclick="batchDeleteServers()" id="batchDeleteServersBtn" style="display: none;">
                        æ‰¹é‡åˆ é™¤é€‰ä¸­
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeServerModal()">å…³é—­</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mobile menu functionality
    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        if (sidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }
    
    function openMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.add('mobile-open');
        overlay.classList.add('show');
    }
    
    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
    }
    
    // Close mobile menu when clicking on navigation items
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                closeMobileMenu();
            });
        });
    });

    // å…¨å±€å˜é‡
    let currentPage = 1;
    let perPage = 10;
    let searchQuery = '';
    let totalPages = 1;
    let selectedMailboxes = new Set();
    let selectedServers = new Set();
    let servers = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadServers();
        loadMailboxes();
    });
    
    // ========== é‚®ç®±ç®¡ç†åŠŸèƒ½ ==========
    
    // åŠ è½½é‚®ç®±åˆ—è¡¨
    async function loadMailboxes(page = 1, search = '') {
        try {
            currentPage = page;
            searchQuery = search;
            
            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                search: search
            });
            
            const response = await fetch(`/admin/api/mailbox?${params}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                renderMailboxTable(data.data);
                renderPagination(data.pagination);
            } else {
                showToast('åŠ è½½é‚®ç®±åˆ—è¡¨å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åŠ è½½é‚®ç®±åˆ—è¡¨å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æ¸²æŸ“é‚®ç®±è¡¨æ ¼
    function renderMailboxTable(mailboxes) {
        const tbody = document.querySelector('#mailboxTable tbody');
        tbody.innerHTML = '';
        
        if (mailboxes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #6b7280;">æš‚æ— é‚®ç®±è´¦å·</td></tr>';
            return;
        }
        
        mailboxes.forEach((mailbox, index) => {
            const row = document.createElement('tr');
            const rowNumber = (currentPage - 1) * perPage + index + 1;
            row.innerHTML = `
                <td><input type="checkbox" class="mailbox-checkbox" value="${mailbox.id}" onchange="toggleMailboxSelection(${mailbox.id})"></td>
                <td>${rowNumber}</td>
                <td>${escapeHtml(mailbox.email)}</td>
                <td>******</td>
                <td>${escapeHtml(mailbox.server)}</td>
                <td>${mailbox.port}/${mailbox.protocol.toUpperCase()}</td>
                <td>${mailbox.ssl ? 'âœ…' : 'âŒ'}</td>
                <td>${escapeHtml(mailbox.remarks || '-')}</td>
                <td>${formatDateTime(mailbox.created_at)}</td>
                <td>
                    <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-small" onclick="editMailbox(${mailbox.id})">ç¼–è¾‘</button>
                        <button class="btn btn-primary btn-small" onclick="testMailbox(${mailbox.id})">æµ‹è¯•</button>
                        <button class="btn btn-primary btn-small" onclick="quickRemark(${mailbox.id})">å¿«æ·å¤‡æ³¨</button>
                        <button class="btn btn-danger btn-small" onclick="deleteMailbox(${mailbox.id})">åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        updateBatchDeleteButton();
    }
    
    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        totalPages = pagination.pages;
        
        let html = `<div class="pagination-info">å…± ${pagination.total} æ¡è®°å½•ï¼Œç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.pages} é¡µ</div>`;
        
        if (pagination.pages > 1) {
            html += '<div class="pagination-buttons">';
            
            // ä¸Šä¸€é¡µ
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="loadMailboxes(${pagination.page - 1}, '${searchQuery}')">Â« ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.pages, pagination.page + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="loadMailboxes(1, '${searchQuery}')">1</button>`;
                if (startPage > 2) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadMailboxes(${i}, '${searchQuery}')">${i}</button>`;
            }
            
            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
                html += `<button class="page-btn" onclick="loadMailboxes(${pagination.pages}, '${searchQuery}')">${pagination.pages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="loadMailboxes(${pagination.page + 1}, '${searchQuery}')">ä¸‹ä¸€é¡µ Â»</button>`;
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
    }
    
    // æ¸…é™¤é‚®ç®±æœç´¢
    function clearMailboxSearch() {
        document.getElementById('searchInput').value = '';
        loadMailboxes(1, '');
    }
    
    // æœç´¢é‚®ç®±
    function searchMailboxes() {
        const search = document.getElementById('searchInput').value.trim();
        loadMailboxes(1, search);
    }
    
    // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
    function changePerPage() {
        perPage = parseInt(document.getElementById('perPageSelect').value);
        loadMailboxes(1, searchQuery);
    }
    
    // æ˜¾ç¤ºæ·»åŠ é‚®ç®±æ¨¡æ€æ¡†
    function showAddModal() {
        document.getElementById('modalTitle').textContent = 'æ·»åŠ é‚®ç®±';
        document.getElementById('formAction').value = 'add';
        document.getElementById('mailboxForm').reset();
        document.getElementById('mailboxId').value = '';
        document.getElementById('ssl').checked = true;
        document.getElementById('testBtn').style.display = 'inline-block';
        loadServerOptions();
        updatePortByProtocol();
        document.getElementById('mailboxModal').classList.add('show');
    }
    
    // æ˜¾ç¤ºæ‰¹é‡æ·»åŠ æ¨¡æ€æ¡†
    function showBatchAddModal() {
        document.getElementById('batchAddForm').reset();
        document.getElementById('batchSsl').checked = true;
        loadBatchServerOptions();
        updateBatchPortByProtocol();
        document.getElementById('batchAddModal').classList.add('show');
    }
    
    // æ˜¾ç¤ºæœåŠ¡å™¨ç®¡ç†æ¨¡æ€æ¡†
    function showServerModal() {
        document.getElementById('serverForm').reset();
        document.getElementById('serverId').value = '';
        document.getElementById('serverAction').value = 'add';
        document.getElementById('serverSaveText').textContent = 'æ·»åŠ æœåŠ¡å™¨';
        // é‡ç½®éšè—å­—æ®µä¸ºé»˜è®¤å€¼
        document.getElementById('defaultPortImap').value = '993';
        document.getElementById('defaultPortPop3').value = '995';
        document.getElementById('serverSslEnabled').value = 'true';
        document.getElementById('serverRemarks').value = '';
        loadServerList();
        document.getElementById('serverModal').classList.add('show');
    }
    
    // ç¼–è¾‘é‚®ç®±
    async function editMailbox(id) {
        try {
            const response = await fetch('/admin/api/mailbox');
            const data = await response.json();
            
            if (data.success) {
                const mailbox = data.data.find(m => m.id === id);
                if (mailbox) {
                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é‚®ç®±';
                    document.getElementById('formAction').value = 'edit';
                    document.getElementById('mailboxId').value = mailbox.id;
                    document.getElementById('email').value = mailbox.email;
                    document.getElementById('password').value = mailbox.password;
                    document.getElementById('server').value = mailbox.server;
                    document.getElementById('port').value = mailbox.port;
                    document.getElementById('protocol').value = mailbox.protocol;
                    document.getElementById('ssl').checked = mailbox.ssl;
                    document.getElementById('remarks').value = mailbox.remarks || '';
                    document.getElementById('testBtn').style.display = 'inline-block';
                    loadServerOptions();
                    document.getElementById('mailboxModal').classList.add('show');
                }
            }
        } catch (error) {
            console.error('è·å–é‚®ç®±ä¿¡æ¯å¤±è´¥:', error);
            showToast('è·å–é‚®ç®±ä¿¡æ¯å¤±è´¥', 'error');
        }
    }
    
    // æµ‹è¯•é‚®ç®±è¿æ¥
    async function testMailbox(id = null) {
        const targetId = id || document.getElementById('mailboxId').value;
        
        if (!targetId) {
            // å¦‚æœæ²¡æœ‰IDï¼Œä½¿ç”¨å½“å‰è¡¨å•æ•°æ®è¿›è¡Œæµ‹è¯•
            const form = document.getElementById('mailboxForm');
            const formData = new FormData(form);
            
            const testData = {
                action: 'test_new',
                email: formData.get('email'),
                password: formData.get('password'),
                server: formData.get('server'),
                port: parseInt(formData.get('port')),
                protocol: formData.get('protocol'),
                ssl: formData.get('ssl') === 'on'
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!testData.email || !testData.password || !testData.server || !testData.port) {
                showToast('è¯·å¡«å†™å®Œæ•´çš„é‚®ç®±ä¿¡æ¯åå†æµ‹è¯•', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/mailbox', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('é‚®ç®±è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    showToast(data.message || 'é‚®ç®±è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æµ‹è¯•é‚®ç®±å¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
            return;
        }
        
        try {
            const response = await fetch('/admin/api/mailbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'test',
                    id: parseInt(targetId)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('é‚®ç®±è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
            } else {
                showToast(data.message || 'é‚®ç®±è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æµ‹è¯•é‚®ç®±å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // å¿«æ·å¤‡æ³¨
    function quickRemark(id) {
        const newRemark = prompt('è¯·è¾“å…¥æ–°çš„å¤‡æ³¨ä¿¡æ¯ï¼š');
        if (newRemark !== null) {
            // è¿™é‡Œå¯ä»¥å®ç°å¿«é€Ÿæ›´æ–°å¤‡æ³¨çš„åŠŸèƒ½
            updateMailboxRemark(id, newRemark);
        }
    }
    
    // æ›´æ–°é‚®ç®±å¤‡æ³¨
    async function updateMailboxRemark(id, remark) {
        try {
            // è·å–å½“å‰é‚®ç®±ä¿¡æ¯
            const response = await fetch('/admin/api/mailbox');
            const data = await response.json();
            
            if (data.success) {
                const mailbox = data.data.find(m => m.id === id);
                if (mailbox) {
                    // æ›´æ–°å¤‡æ³¨
                    const updateResponse = await fetch('/admin/api/mailbox', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'edit',
                            id: id,
                            email: mailbox.email,
                            password: mailbox.password,
                            server: mailbox.server,
                            port: mailbox.port,
                            protocol: mailbox.protocol,
                            ssl: mailbox.ssl,
                            remarks: remark
                        })
                    });
                    
                    const updateData = await updateResponse.json();
                    
                    if (updateData.success) {
                        showToast('å¤‡æ³¨æ›´æ–°æˆåŠŸ', 'success');
                        loadMailboxes(currentPage, searchQuery);
                    } else {
                        showToast(updateData.message || 'å¤‡æ³¨æ›´æ–°å¤±è´¥', 'error');
                    }
                }
            }
        } catch (error) {
            console.error('æ›´æ–°å¤‡æ³¨å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // åˆ é™¤é‚®ç®±
    async function deleteMailbox(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‚®ç®±è´¦å·å—ï¼Ÿ')) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/mailbox', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: id })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('é‚®ç®±åˆ é™¤æˆåŠŸ', 'success');
                loadMailboxes(currentPage, searchQuery);
            } else {
                showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åˆ é™¤é‚®ç®±å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ä¿å­˜é‚®ç®±
    async function saveMailbox() {
        const form = document.getElementById('mailboxForm');
        const formData = new FormData(form);
        
        const data = {
            action: formData.get('action'),
            email: formData.get('email'),
            password: formData.get('password'),
            server: formData.get('server'),
            port: parseInt(formData.get('port')),
            protocol: formData.get('protocol'),
            ssl: formData.get('ssl') === 'on',
            remarks: formData.get('remarks')
        };
        
        if (data.action === 'edit') {
            data.id = parseInt(formData.get('id'));
        }
        
        try {
            const response = await fetch('/admin/api/mailbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'ä¿å­˜æˆåŠŸ', 'success');
                closeModal();
                loadMailboxes(currentPage, searchQuery);
            } else {
                showToast(result.message || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('ä¿å­˜é‚®ç®±å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æ‰¹é‡æ·»åŠ é‚®ç®±
    async function saveBatchMailboxes() {
        const form = document.getElementById('batchAddForm');
        const formData = new FormData(form);
        
        const data = {
            action: 'batch_add',
            batch_content: formData.get('batch_content'),
            server: formData.get('server'),
            port: parseInt(formData.get('port')),
            protocol: formData.get('protocol'),
            ssl: formData.get('ssl') === 'on',
            remarks: formData.get('remarks')
        };
        
        if (!data.batch_content || !data.server || !data.port) {
            showToast('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
            return;
        }
        
        try {
            const response = await fetch('/admin/api/mailbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'æ‰¹é‡æ·»åŠ æˆåŠŸ', 'success');
                closeBatchAddModal();
                loadMailboxes(currentPage, searchQuery);
            } else {
                showToast(result.message || 'æ‰¹é‡æ·»åŠ å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡æ·»åŠ å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== é€‰æ‹©ç®¡ç†åŠŸèƒ½ ==========
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.mailbox-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            if (selectAll.checked) {
                selectedMailboxes.add(parseInt(checkbox.value));
            } else {
                selectedMailboxes.delete(parseInt(checkbox.value));
            }
        });
        
        updateBatchDeleteButton();
    }
    
    // åˆ‡æ¢é‚®ç®±é€‰æ‹©çŠ¶æ€
    function toggleMailboxSelection(id) {
        if (selectedMailboxes.has(id)) {
            selectedMailboxes.delete(id);
        } else {
            selectedMailboxes.add(id);
        }
        updateBatchDeleteButton();
    }
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        const btn = document.getElementById('batchDeleteBtn');
        if (selectedMailboxes.size > 0) {
            btn.style.display = 'inline-block';
            btn.textContent = `ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (${selectedMailboxes.size})`;
        } else {
            btn.style.display = 'none';
        }
    }
    
    // æ‰¹é‡åˆ é™¤é‚®ç®±
    async function batchDeleteMailboxes() {
        if (selectedMailboxes.size === 0) {
            showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„é‚®ç®±', 'error');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMailboxes.size} ä¸ªé‚®ç®±è´¦å·å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/mailbox', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'batch_delete',
                    ids: Array.from(selectedMailboxes)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                selectedMailboxes.clear();
                loadMailboxes(currentPage, searchQuery);
            } else {
                showToast(data.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== æœåŠ¡å™¨ç®¡ç†åŠŸèƒ½ ==========
    
    // åŠ è½½æœåŠ¡å™¨åˆ—è¡¨
    async function loadServers() {
        try {
            const response = await fetch('/admin/api/servers');
            const data = await response.json();
            
            if (data.success) {
                servers = data.data;
                loadServerOptions();
                loadBatchServerOptions();
            }
        } catch (error) {
            console.error('åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½æœåŠ¡å™¨é€‰é¡¹åˆ°æ·»åŠ é‚®ç®±è¡¨å•
    function loadServerOptions() {
        const select = document.getElementById('serverSelect');
        select.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰æœåŠ¡å™¨æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
        
        servers.forEach(server => {
            const option = document.createElement('option');
            option.value = server.id;
            option.textContent = `${server.server_name} (${server.server_address})`;
            select.appendChild(option);
        });
    }
    
    // åŠ è½½æœåŠ¡å™¨é€‰é¡¹åˆ°æ‰¹é‡æ·»åŠ è¡¨å•
    function loadBatchServerOptions() {
        const select = document.getElementById('batchServerSelect');
        select.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰æœåŠ¡å™¨æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
        
        servers.forEach(server => {
            const option = document.createElement('option');
            option.value = server.id;
            option.textContent = `${server.server_name} (${server.server_address})`;
            select.appendChild(option);
        });
    }
    
    // é€‰æ‹©æœåŠ¡å™¨
    function selectServer() {
        const select = document.getElementById('serverSelect');
        const serverId = select.value;
        
        if (serverId) {
            const server = servers.find(s => s.id == serverId);
            if (server) {
                document.getElementById('server').value = server.server_address;
                document.getElementById('ssl').checked = server.ssl_enabled;
                updatePortByProtocol();
            }
        }
    }
    
    // é€‰æ‹©æ‰¹é‡æ·»åŠ æœåŠ¡å™¨
    function selectBatchServer() {
        const select = document.getElementById('batchServerSelect');
        const serverId = select.value;
        
        if (serverId) {
            const server = servers.find(s => s.id == serverId);
            if (server) {
                document.getElementById('batchServer').value = server.server_address;
                document.getElementById('batchSsl').checked = server.ssl_enabled;
                updateBatchPortByProtocol();
            }
        }
    }
    
    // æ ¹æ®åè®®æ›´æ–°ç«¯å£
    function updatePortByProtocol() {
        const protocol = document.getElementById('protocol').value;
        const ssl = document.getElementById('ssl').checked;
        const portInput = document.getElementById('port');
        
        if (protocol === 'imap') {
            portInput.value = ssl ? 993 : 143;
        } else if (protocol === 'pop3') {
            portInput.value = ssl ? 995 : 110;
        }
    }
    
    // æ ¹æ®SSLæ›´æ–°ç«¯å£
    function updatePortBySSL() {
        updatePortByProtocol();
    }
    
    // æ ¹æ®åè®®æ›´æ–°æ‰¹é‡æ·»åŠ ç«¯å£
    function updateBatchPortByProtocol() {
        const protocol = document.getElementById('batchProtocol').value;
        const ssl = document.getElementById('batchSsl').checked;
        const portInput = document.getElementById('batchPort');
        
        if (protocol === 'imap') {
            portInput.value = ssl ? 993 : 143;
        } else if (protocol === 'pop3') {
            portInput.value = ssl ? 995 : 110;
        }
    }
    
    // æ ¹æ®SSLæ›´æ–°æ‰¹é‡æ·»åŠ ç«¯å£
    function updateBatchPortBySSL() {
        updateBatchPortByProtocol();
    }
    
    // åŠ è½½æœåŠ¡å™¨ç®¡ç†åˆ—è¡¨
    async function loadServerList() {
        try {
            const response = await fetch('/admin/api/servers');
            const data = await response.json();
            
            if (data.success) {
                renderServerList(data.data);
            }
        } catch (error) {
            console.error('åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“æœåŠ¡å™¨åˆ—è¡¨ - å¸ƒå±€ï¼šåºå·IDï¼ŒæœåŠ¡å™¨åç§°ï¼ŒæœåŠ¡å™¨åœ°å€
    function renderServerList(serverList) {
        const container = document.getElementById('serverList');
        container.innerHTML = '';
        
        if (serverList.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">æš‚æ— æœåŠ¡å™¨é…ç½®</div>';
            return;
        }
        
        serverList.forEach((server, index) => {
            const item = document.createElement('div');
            item.className = 'server-item';
            const rowNumber = index + 1;
            item.innerHTML = `
                <input type="checkbox" class="server-checkbox" value="${server.id}" onchange="toggleServerSelection(${server.id})" style="margin-right: 10px;">
                <div class="server-info">
                    <div class="server-id">åºå·: ${rowNumber}</div>
                    <div class="server-name">${escapeHtml(server.server_name)}</div>
                    <div class="server-address">${escapeHtml(server.server_address)}</div>
                </div>
                <div class="server-actions">
                    <button class="btn btn-success btn-small" onclick="editServer(${server.id})">ç¼–è¾‘</button>
                    <button class="btn btn-danger btn-small" onclick="deleteServer(${server.id})">åˆ é™¤</button>
                </div>
            `;
            container.appendChild(item);
        });
        
        updateBatchDeleteServersButton();
    }
    
    // åˆ‡æ¢æœåŠ¡å™¨é€‰æ‹©çŠ¶æ€
    function toggleServerSelection(id) {
        if (selectedServers.has(id)) {
            selectedServers.delete(id);
        } else {
            selectedServers.add(id);
        }
        updateBatchDeleteServersButton();
    }
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æœåŠ¡å™¨æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteServersButton() {
        const btn = document.getElementById('batchDeleteServersBtn');
        if (selectedServers.size > 0) {
            btn.style.display = 'inline-block';
            btn.textContent = `æ‰¹é‡åˆ é™¤é€‰ä¸­ (${selectedServers.size})`;
        } else {
            btn.style.display = 'none';
        }
    }
    
    // ä¿å­˜æœåŠ¡å™¨
    async function saveServer() {
        const form = document.getElementById('serverForm');
        const formData = new FormData(form);
        
        const data = {
            action: formData.get('action'),
            server_name: formData.get('server_name'),
            server_address: formData.get('server_address'),
            default_port_imap: parseInt(formData.get('default_port_imap')),
            default_port_pop3: parseInt(formData.get('default_port_pop3')),
            ssl_enabled: formData.get('ssl_enabled') === 'true',
            remarks: formData.get('remarks')
        };
        
        if (data.action === 'edit') {
            data.id = parseInt(formData.get('id'));
        }
        
        try {
            const response = await fetch('/admin/api/servers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'æœåŠ¡å™¨ä¿å­˜æˆåŠŸ', 'success');
                document.getElementById('serverForm').reset();
                document.getElementById('serverId').value = '';
                document.getElementById('serverAction').value = 'add';
                document.getElementById('serverSaveText').textContent = 'æ·»åŠ æœåŠ¡å™¨';
                // é‡ç½®éšè—å­—æ®µä¸ºé»˜è®¤å€¼
                document.getElementById('defaultPortImap').value = '993';
                document.getElementById('defaultPortPop3').value = '995';
                document.getElementById('serverSslEnabled').value = 'true';
                document.getElementById('serverRemarks').value = '';
                loadServers();
                loadServerList();
            } else {
                showToast(result.message || 'æœåŠ¡å™¨ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('ä¿å­˜æœåŠ¡å™¨å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ç¼–è¾‘æœåŠ¡å™¨
    function editServer(id) {
        const server = servers.find(s => s.id === id);
        if (server) {
            document.getElementById('serverId').value = server.id;
            document.getElementById('serverAction').value = 'edit';
            document.getElementById('serverName').value = server.server_name;
            document.getElementById('serverAddress').value = server.server_address;
            // éšè—å­—æ®µä¿æŒåŸå€¼
            document.getElementById('defaultPortImap').value = server.default_port_imap;
            document.getElementById('defaultPortPop3').value = server.default_port_pop3;
            document.getElementById('serverSslEnabled').value = server.ssl_enabled ? 'true' : 'false';
            document.getElementById('serverRemarks').value = server.remarks || '';
            document.getElementById('serverSaveText').textContent = 'æ›´æ–°æœåŠ¡å™¨';
        }
    }
    
    // åˆ é™¤æœåŠ¡å™¨
    async function deleteServer(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœåŠ¡å™¨é…ç½®å—ï¼Ÿ')) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/servers', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ids: [id] })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('æœåŠ¡å™¨åˆ é™¤æˆåŠŸ', 'success');
                loadServers();
                loadServerList();
            } else {
                showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åˆ é™¤æœåŠ¡å™¨å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // æ‰¹é‡åˆ é™¤æœåŠ¡å™¨
    async function batchDeleteServers() {
        if (selectedServers.size === 0) {
            showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„æœåŠ¡å™¨', 'error');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedServers.size} ä¸ªæœåŠ¡å™¨é…ç½®å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/servers', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ids: Array.from(selectedServers) })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message || 'æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                selectedServers.clear();
                loadServers();
                loadServerList();
            } else {
                showToast(data.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }
    
    // ========== æ¨¡æ€æ¡†ç®¡ç† ==========
    
    // å…³é—­æ·»åŠ /ç¼–è¾‘é‚®ç®±æ¨¡æ€æ¡†
    function closeModal() {
        document.getElementById('mailboxModal').classList.remove('show');
    }
    
    // å…³é—­æ‰¹é‡æ·»åŠ æ¨¡æ€æ¡†
    function closeBatchAddModal() {
        document.getElementById('batchAddModal').classList.remove('show');
    }
    
    // å…³é—­æœåŠ¡å™¨ç®¡ç†æ¨¡æ€æ¡†
    function closeServerModal() {
        document.getElementById('serverModal').classList.remove('show');
        selectedServers.clear();
        updateBatchDeleteServersButton();
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('mailboxModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    document.getElementById('batchAddModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeBatchAddModal();
        }
    });
    
    document.getElementById('serverModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeServerModal();
        }
    });
    
    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
            closeBatchAddModal();
            closeServerModal();
        }
        
        if (e.key === 'Enter' && document.getElementById('searchInput') === document.activeElement) {
            searchMailboxes();
        }
    });
    
    // ========== å·¥å…·å‡½æ•° ==========
    
    // Toasté€šçŸ¥ç³»ç»Ÿ
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleString('zh-CN');
    }
</script>
{% endblock %}