{% extends "base.html" %}

{% block title %}å¡å¯†ç®¡ç† - {{ system_title }}{% endblock %}

{% block head %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --sidebar-width: 280px;
        --header-height: 70px;
        --transition: all 0.3s ease;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        line-height: 1.6;
        color: #334155;
        transition: var(--transition);
    }
    
    /* Sidebar Styles */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        z-index: 1000;
        transition: var(--transition);
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-logo {
        color: white;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        padding: 20px 0;
    }
    
    .nav-item {
        display: block;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        padding: 15px 25px;
        transition: var(--transition);
        border-left: 3px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.1);
        transform: translateX(-100%);
        transition: var(--transition);
    }
    
    .nav-item:hover::before {
        transform: translateX(0);
    }
    
    .nav-item:hover,
    .nav-item.active {
        color: white;
        background: rgba(255,255,255,0.15);
        border-left-color: white;
        transform: translateX(5px);
    }
    
    .nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Main Content */
    .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        transition: var(--transition);
    }
    
    .header {
        background: white;
        height: var(--header-height);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 999;
    }
    
    .header-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #64748b;
    }
    
    .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
    }
    
    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    /* Content Area */
    .content {
        padding: 30px;
    }
    
    /* Cards */
    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 25px;
        transition: var(--transition);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
    }
    
    .card-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .card-body {
        padding: 25px;
    }
    
    /* Buttons */
    .btn {
        display: inline-block;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        transform: translateY(-2px);
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    /* Search Controls Styles */
    .search-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: nowrap; /* Prevent wrapping unless specifically needed */
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 550px; /* Increased from 400px for longer search box */
        min-width: 0; /* Allow shrinking */
    }
    
    .search-box input {
        flex: 1;
        min-width: 200px; /* Increased from 150px for better appearance */
        padding: 10px 16px; /* Enhanced padding for better visual appeal */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .search-box input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }
    
    .page-controls select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    
    /* Table */
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .table th {
        background: #f8fafc;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: #f9fafb;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-active {
        background: #dcfce7;
        color: #166534;
    }
    
    .status-used {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-expired {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-disabled {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    /* Pagination */
    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .pagination-info {
        color: #6b7280;
        font-size: 14px;
        margin-right: 20px;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #374151;
        text-decoration: none;
        border-radius: 6px;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .page-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }
    
    .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #f1f5f9;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    /* Form */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    /* Checkbox */
    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .form-check input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
    }
    
    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-align: center;
        border-left: 4px solid var(--primary-color);
    }
    
    .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6b7280;
    }
    
    /* Loading */
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid #f3f4f6;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }
    
    .toast {
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transform: translateX(450px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        background: #6b7280;
        margin-bottom: 10px;
    }
    
    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }
    
    .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .toast.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .toast.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    /* Alert (deprecated - replaced by toast) */
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid;
    }
    
    .alert-success {
        background: #f0fdf4;
        border-color: #22c55e;
        color: #166534;
    }
    
    .alert-error {
        background: #fef2f2;
        border-color: #ef4444;
        color: #991b1b;
    }
    
    .alert-info {
        background: #f0f9ff;
        border-color: #3b82f6;
        color: #1e40af;
    }
    
    /* Mobile menu toggle - default hidden */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
        transition: var(--transition);
    }
    
    .mobile-menu-toggle:hover {
        color: var(--primary-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .header-title {
            font-size: 20px;
        }
        
        .content {
            padding: 20px;
        }
        
        .mobile-menu-toggle {
            display: block !important;
        }
        
        .card-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .modal-content {
            width: 95%;
            margin: 20px;
        }
        
        .table-container {
            font-size: 12px;
        }
    }
    
    /* Mobile overlay */
    .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    
    .mobile-overlay.show {
        display: block;
    }
</style>
{% endblock %}

{% block body %}
<!-- Toast notification container -->
<div id="toast-container" class="toast-container"></div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“§ é‚®ä»¶ç®¡ç†ç³»ç»Ÿ</div>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('admin_home') }}" class="nav-item">
            <i>ğŸ </i> é¦–é¡µ
        </a>
        <a href="{{ url_for('admin_mailbox') }}" class="nav-item">
            <i>ğŸ“«</i> é‚®ç®±ç®¡ç†
        </a>
        <a href="{{ url_for('admin_daili') }}" class="nav-item">
            <i>ğŸŒ</i> ä»£ç†æ± 
        </a>
        <a href="{{ url_for('admin_kami') }}" class="nav-item active">
            <i>ğŸ”‘</i> å¡å¯†ç®¡ç†
        </a>
        <a href="{{ url_for('admin_kamirizhi') }}" class="nav-item">
            <i>ğŸ“</i> å¡å¯†æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_shoujian') }}" class="nav-item">
            <i>ğŸ“§</i> æ”¶ä»¶æ—¥å¿—
        </a>
        <a href="{{ url_for('admin_system') }}" class="nav-item">
            <i>âš™ï¸</i> ç³»ç»Ÿè®¾ç½®
        </a>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
            <h1 class="header-title">å¡å¯†ç®¡ç†</h1>
        </div>
        <div class="header-actions">
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ{{ admin_username }}</span>
            </div>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </div>
    
    <div class="content">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCards">0</div>
                <div class="stat-label">æ€»å¡å¯†æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCards">0</div>
                <div class="stat-label">å¯ç”¨å¡å¯†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usedCards">0</div>
                <div class="stat-label">å·²ä½¿ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiredCards">0</div>
                <div class="stat-label">å·²è¿‡æœŸ</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">å¡å¯†ç®¡ç†</h2>
            </div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showGenerateModal()">
                        <i>â•</i> ç”Ÿæˆå¡å¯†
                    </button>
                    <button class="btn btn-success" onclick="showBatchGenerateModal()">
                        <i>ğŸ“¦</i> æ‰¹é‡ç”Ÿæˆå¡å¯†
                    </button>
                    <button class="btn btn-secondary" onclick="showRecycleBinModal()">
                        <i>ğŸ—‘ï¸</i> å›æ”¶ç«™
                    </button>
                    <button class="btn btn-danger" onclick="batchDeleteCards()" style="display: none;" id="batchDeleteBtn">
                        <i>ğŸ—‘ï¸</i> æ‰¹é‡åˆ é™¤
                    </button>
                    <button class="btn btn-secondary" onclick="refreshCardList()">
                        <i>ğŸ”„</i> åˆ·æ–°
                    </button>
                </div>

                <!-- æœç´¢å’Œåˆ†é¡µæ§åˆ¶ -->
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="æœç´¢å¡å¯†..." onkeyup="searchCards()">
                        <button class="btn btn-primary" onclick="searchCards()">ğŸ” æœç´¢</button>
                        <button class="btn btn-danger" onclick="clearSearch()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="page-controls">
                        <select id="perPageSelect" onchange="changePerPage()">
                            <option value="10">æ¯é¡µ10æ¡</option>
                            <option value="20" selected>æ¯é¡µ20æ¡</option>
                            <option value="50">æ¯é¡µ50æ¡</option>
                        </select>
                    </div>
                </div>

                <!-- å¡å¯†åˆ—è¡¨ -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>åºå·ID</th>
                                <th>å¡å¯†</th>
                                <th>ä½¿ç”¨æ¬¡æ•°</th>
                                <th>ä½¿ç”¨æ—¶é—´</th>
                                <th>è¿‡æœŸæ—¶é—´</th>
                                <th>ç»‘å®šé‚®ç®±</th>
                                <th>é‚®ä»¶è¿‡æ»¤</th>
                                <th>å¤‡æ³¨</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cardListBody">
                            <tr>
                                <td colspan="10" class="loading">
                                    <div class="spinner"></div>
                                    <div>åŠ è½½ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µå¯¼èˆª -->
                <div class="pagination-container" id="paginationContainer">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç”Ÿæˆå¡å¯†å¼¹çª— -->
    <div id="generateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç”Ÿæˆå¡å¯†</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="generateForm">
                    <div class="form-group">
                        <label class="form-label">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                        <input type="number" class="form-control" name="usage_limit" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ”¶å–Xå¤©å†…çš„é‚®ä»¶</label>
                        <input type="number" class="form-control" name="email_days_filter" value="1" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…³é”®è¯é‚®ä»¶</label>
                        <input type="text" class="form-control" name="keyword_filter" placeholder="è®¾ç½®å…³é”®è¯ååªæ”¶å–æ ‡é¢˜åŒ…å«å…³é”®è¯çš„é‚®ä»¶ï¼Œå¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                        <small style="color: #6b7280;">ç•™ç©ºåˆ™ä¸é™åˆ¶å…³é”®è¯</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¿‡æœŸæ—¶é—´</label>
                        <input type="text" class="form-control" name="expired_at" placeholder="æ”¯æŒæ ¼å¼ï¼š1ã€7ã€30ã€100 æˆ– 1å¤©ã€7å¤©ã€30å¤© æˆ–å…·ä½“æ—¥æœŸæ—¶é—´">
                        <small style="color: #6b7280;">æ”¯æŒæ ¼å¼ï¼šæ•°å­—å¤©æ•°ï¼ˆå¦‚ï¼š1ã€100ï¼‰ã€å¤©æ•°+å¤©å­—ï¼ˆå¦‚ï¼š1å¤©ã€7å¤©ï¼‰æˆ–å…·ä½“æ—¥æœŸæ—¶é—´ï¼Œç•™ç©ºåˆ™æ°¸ä¸è¿‡æœŸï¼Œä½¿ç”¨åŒ—äº¬æ—¶é—´</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤‡æ³¨</label>
                        <input type="text" class="form-control" name="remarks" placeholder="å¡å¯†ç”¨é€”è¯´æ˜">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('generateModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="generateCard()">ç”Ÿæˆå¡å¯†</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ç”Ÿæˆå¡å¯†å¼¹çª— -->
    <div id="batchGenerateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ‰¹é‡ç”Ÿæˆå¡å¯†</h3>
                <button class="modal-close" onclick="closeModal('batchGenerateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="batchGenerateForm">
                    <div class="form-group">
                        <label class="form-label">ç”Ÿæˆæ•°é‡</label>
                        <input type="number" class="form-control" name="count" value="10" min="1" max="100" required>
                        <small style="color: #6b7280;">æœ€å¤šä¸€æ¬¡ç”Ÿæˆ100ä¸ª</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                        <input type="number" class="form-control" name="usage_limit" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ”¶å–Xå¤©å†…çš„é‚®ä»¶</label>
                        <input type="number" class="form-control" name="email_days_filter" value="1" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…³é”®è¯é‚®ä»¶</label>
                        <input type="text" class="form-control" name="keyword_filter" placeholder="è®¾ç½®å…³é”®è¯ååªæ”¶å–æ ‡é¢˜åŒ…å«å…³é”®è¯çš„é‚®ä»¶ï¼Œå¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                        <small style="color: #6b7280;">ç•™ç©ºåˆ™ä¸é™åˆ¶å…³é”®è¯</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¿‡æœŸæ—¶é—´</label>
                        <input type="text" class="form-control" name="expired_at" placeholder="æ”¯æŒæ ¼å¼ï¼š1ã€7ã€30ã€100 æˆ– 1å¤©ã€7å¤©ã€30å¤© æˆ–å…·ä½“æ—¥æœŸæ—¶é—´">
                        <small style="color: #6b7280;">æ”¯æŒæ ¼å¼ï¼šæ•°å­—å¤©æ•°ï¼ˆå¦‚ï¼š1ã€100ï¼‰ã€å¤©æ•°+å¤©å­—ï¼ˆå¦‚ï¼š1å¤©ã€7å¤©ï¼‰æˆ–å…·ä½“æ—¥æœŸæ—¶é—´ï¼Œç•™ç©ºåˆ™æ°¸ä¸è¿‡æœŸï¼Œä½¿ç”¨åŒ—äº¬æ—¶é—´</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤‡æ³¨</label>
                        <input type="text" class="form-control" name="remarks" placeholder="æ‰¹é‡å¡å¯†ç”¨é€”è¯´æ˜">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('batchGenerateModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="batchGenerateCards()">æ‰¹é‡ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- ç»‘å®šé‚®ç®±å¼¹çª— -->
    <div id="bindEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç»‘å®šé‚®ç®±</h3>
                <button class="modal-close" onclick="closeModal('bindEmailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bindEmailForm">
                    <input type="hidden" name="card_id" id="bindCardId">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©é‚®ç®±</label>
                        <select class="form-control" name="email_id" id="emailSelect" required>
                            <option value="">è¯·é€‰æ‹©é‚®ç®±è´¦å·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¡å¯†</label>
                        <input type="text" class="form-control" id="bindCardKey" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bindEmailModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="bindEmail()">ç»‘å®š</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¡å¯†å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘å¡å¯†</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="card_id" id="editCardId">
                    
                    <div class="form-group">
                        <label class="form-label">å¡å¯†</label>
                        <input type="text" class="form-control" id="editCardKey" readonly>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç»‘å®šé‚®ç®±</label>
                            <select class="form-control" name="bound_email_id" id="editBoundEmailId">
                                <option value="">è¯·é€‰æ‹©é‚®ç®±è´¦å·</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ”¶å–Xå¤©å†…çš„é‚®ä»¶</label>
                            <input type="number" class="form-control" name="email_days_filter" id="editEmailDaysFilter" value="1" min="1" max="365">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å…³é”®è¯é‚®ä»¶</label>
                        <input type="text" class="form-control" name="keyword_filter" id="editKeywordFilter" placeholder="è®¾ç½®å…³é”®è¯ååªæ”¶å–æ ‡é¢˜åŒ…å«å…³é”®è¯çš„é‚®ä»¶ï¼Œå¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                        <small style="color: #6b7280;">ç•™ç©ºåˆ™ä¸é™åˆ¶å…³é”®è¯</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                            <input type="number" class="form-control" name="usage_limit" id="editUsageLimit" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¿‡æœŸæ—¶é—´</label>
                            <input type="text" class="form-control" name="expired_at" id="editExpiredAt" placeholder="æ”¯æŒæ ¼å¼ï¼š1ã€7ã€30ã€100 æˆ– 1å¤©ã€7å¤©ã€30å¤© æˆ–å…·ä½“æ—¥æœŸæ—¶é—´">
                            <small style="color: #6b7280;">æ”¯æŒæ ¼å¼ï¼šæ•°å­—å¤©æ•°ï¼ˆå¦‚ï¼š1ã€100ï¼‰ã€å¤©æ•°+å¤©å­—ï¼ˆå¦‚ï¼š1å¤©ã€7å¤©ï¼‰æˆ–å…·ä½“æ—¥æœŸæ—¶é—´ï¼Œç•™ç©ºåˆ™æ°¸ä¸è¿‡æœŸï¼Œä½¿ç”¨åŒ—äº¬æ—¶é—´</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å¤‡æ³¨</label>
                        <input type="text" class="form-control" name="remarks" id="editRemarks" placeholder="å¡å¯†ç”¨é€”è¯´æ˜">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="generateCardAPI()">ç”ŸæˆAPI</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›æ”¶ç«™å¼¹çª— -->
    <div id="recycleBinModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ—‘ï¸ å¡å¯†å›æ”¶ç«™</h3>
                <button class="modal-close" onclick="closeModal('recycleBinModal')">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <!-- åˆ†ç±»æ ‡ç­¾ -->
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-sm" id="deletedTabBtn" onclick="switchRecycleBinTab('deleted')" 
                            style="background: #ef4444; color: white; margin-right: 10px;">
                        å·²åˆ é™¤çš„å¡å¯† (<span id="deletedCount">0</span>)
                    </button>
                    <button class="btn btn-sm" id="expiredTabBtn" onclick="switchRecycleBinTab('expired')" 
                            style="background: #f59e0b; color: white;">
                        å·²è¿‡æœŸçš„å¡å¯† (<span id="expiredCount">0</span>)
                    </button>
                </div>
                
                <!-- å›æ”¶ç«™å†…å®¹ -->
                <div id="recycleBinContent">
                    <div class="loading" id="recycleBinLoading">
                        <div class="spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                    
                    <!-- å·²åˆ é™¤çš„å¡å¯† -->
                    <div id="deletedCardsContent" style="display: none;">
                        <h4 style="color: #ef4444; margin-bottom: 15px;">å·²åˆ é™¤çš„å¡å¯†</h4>
                        <div id="deletedBatchActions" style="margin-bottom: 10px; display: none;">
                            <button class="btn btn-primary btn-sm" onclick="batchRestoreRecycleItems('deleted')" id="batchRestoreDeletedBtn">
                                ğŸ”„ æ‰¹é‡æ¢å¤ (0)
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="batchPermanentDeleteRecycleItems('deleted')" id="batchDeleteDeletedBtn">
                                ğŸ—‘ï¸ æ‰¹é‡æ°¸ä¹…åˆ é™¤ (0)
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllDeleted" onchange="toggleSelectAllRecycleItems('deleted')">
                                        </th>
                                        <th>åºå·</th>
                                        <th>å¡å¯†</th>
                                        <th>ä½¿ç”¨æ¬¡æ•°</th>
                                        <th>åˆ é™¤æ—¶é—´</th>
                                        <th>åˆ é™¤åŸå› </th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedCardsBody">
                                    <!-- åŠ¨æ€å†…å®¹ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- å·²è¿‡æœŸçš„å¡å¯† -->
                    <div id="expiredCardsContent" style="display: none;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px;">å·²è¿‡æœŸçš„å¡å¯†</h4>
                        <div id="expiredBatchActions" style="margin-bottom: 10px; display: none;">
                            <button class="btn btn-primary btn-sm" onclick="batchRestoreRecycleItems('expired')" id="batchRestoreExpiredBtn">
                                ğŸ”„ æ‰¹é‡æ¢å¤ (0)
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="batchPermanentDeleteRecycleItems('expired')" id="batchDeleteExpiredBtn">
                                ğŸ—‘ï¸ æ‰¹é‡æ°¸ä¹…åˆ é™¤ (0)
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllExpired" onchange="toggleSelectAllRecycleItems('expired')">
                                        </th>
                                        <th>åºå·</th>
                                        <th>å¡å¯†</th>
                                        <th>ä½¿ç”¨æ¬¡æ•°</th>
                                        <th>è¿‡æœŸæ—¶é—´</th>
                                        <th>è¿‡æœŸåŸå› </th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="expiredCardsBody">
                                    <!-- åŠ¨æ€å†…å®¹ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('recycleBinModal')">å…³é—­</button>
                <button type="button" class="btn btn-danger" onclick="clearRecycleBin()">æ¸…ç©ºå›æ”¶ç«™</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mobile menu functionality
    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        if (sidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }
    
    function openMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.add('mobile-open');
        overlay.classList.add('show');
    }
    
    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
    }
    
    // Close mobile menu when clicking on navigation items
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                closeMobileMenu();
            });
        });
    });

    // å…¨å±€å˜é‡
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let selectedCards = new Set();
    let allCards = [];
    let filteredCards = [];

    // ========== æ—¥æœŸè§£æå‡½æ•° ==========
    
    // è§£æè¿‡æœŸæ—¶é—´è¾“å…¥ï¼ˆæ”¯æŒ"1å¤©"ã€"7å¤©"ç­‰æ ¼å¼ï¼‰
    function parseExpirationInput(input) {
        if (!input || input.trim() === '') {
            return null; // ç©ºå€¼è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
        }
        
        input = input.trim();
        
        // åŒ¹é…çº¯æ•°å­—ï¼ˆå¤©æ•°ï¼‰ï¼š1ã€7ã€30ã€100ç­‰
        const numberMatch = input.match(/^(\d+)$/);
        if (numberMatch) {
            const days = parseInt(numberMatch[1]);
            // ä½¿ç”¨åŒ—äº¬æ—¶é—´ (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8å°æ—¶çš„æ¯«ç§’æ•°
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' '); // MySQL datetime format
        }
        
        // åŒ¹é…ä¸­æ–‡å¤©æ•°æ ¼å¼ï¼š1å¤©ã€7å¤©ã€30å¤©ç­‰
        const dayMatch = input.match(/^(\d+)å¤©$/);
        if (dayMatch) {
            const days = parseInt(dayMatch[1]);
            // ä½¿ç”¨åŒ—äº¬æ—¶é—´ (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8å°æ—¶çš„æ¯«ç§’æ•°
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' '); // MySQL datetime format
        }
        
        // åŒ¹é…å…¶ä»–å¯èƒ½çš„æ ¼å¼ï¼š1dã€7dç­‰
        const dayMatchEn = input.match(/^(\d+)d$/i);
        if (dayMatchEn) {
            const days = parseInt(dayMatchEn[1]);
            // ä½¿ç”¨åŒ—äº¬æ—¶é—´ (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8å°æ—¶çš„æ¯«ç§’æ•°
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' ');
        }
        
        // å°è¯•è§£æå…·ä½“çš„æ—¥æœŸæ—¶é—´æ ¼å¼
        try {
            // æ”¯æŒ YYYY-MM-DD HH:mm:ss æ ¼å¼
            if (input.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
                return input;
            }
            
            // æ”¯æŒ YYYY-MM-DD HH:mm æ ¼å¼
            if (input.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                return input + ':00';
            }
            
            // æ”¯æŒ YYYY-MM-DD æ ¼å¼ï¼ˆé»˜è®¤23:59:59ï¼‰
            if (input.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return input + ' 23:59:59';
            }
            
            // å°è¯•è§£æå…¶ä»–æ ¼å¼å¹¶è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
            const date = new Date(input);
            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }
            return date.toISOString().slice(0, 19).replace('T', ' ');
        } catch (e) {
            // è§£æå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            throw new Error(`æ— æ³•è§£ææ—¥æœŸæ ¼å¼ï¼š"${input}"ã€‚æ”¯æŒæ ¼å¼ï¼šæ•°å­—å¤©æ•°ï¼ˆå¦‚ï¼š1ã€7ã€30ã€100ï¼‰ã€å¤©æ•°+å¤©å­—ï¼ˆå¦‚ï¼š1å¤©ã€7å¤©ï¼‰æˆ–å…·ä½“æ—¥æœŸæ—¶é—´ï¼ˆå¦‚ï¼šYYYY-MM-DD HH:mm:ssï¼‰`);
        }
    }
    
    // æ ¼å¼åŒ–è¿‡æœŸæ—¶é—´æ˜¾ç¤ºï¼ˆå°†æ•°æ®åº“æ ¼å¼è½¬æ¢ä¸ºæ˜“è¯»æ ¼å¼ï¼‰
    function formatExpirationDisplay(dateString) {
        if (!dateString) {
            return 'æ°¸ä¸è¿‡æœŸ';
        }
        
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `å·²è¿‡æœŸ (${formatDateTime(dateString)})`;
            } else if (diffDays === 0) {
                return `ä»Šå¤©è¿‡æœŸ (${formatDateTime(dateString)})`;
            } else if (diffDays === 1) {
                return `æ˜å¤©è¿‡æœŸ (${formatDateTime(dateString)})`;
            } else if (diffDays <= 30) {
                return `${diffDays}å¤©åè¿‡æœŸ (${formatDateTime(dateString)})`;
            } else {
                return formatDateTime(dateString);
            }
        } catch (e) {
            return dateString;
        }
    }

    // ========== å·¥å…·å‡½æ•° ==========
    
    // Toasté€šçŸ¥ç³»ç»Ÿ
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadCardStats();
        loadCardList();
        loadEmailList();
    });

    // åŠ è½½å¡å¯†ç»Ÿè®¡
    function loadCardStats() {
        fetch('/admin/api/cards/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalCards').textContent = data.stats.total || 0;
                    document.getElementById('activeCards').textContent = data.stats.active || 0;
                    document.getElementById('usedCards').textContent = data.stats.used || 0;
                    document.getElementById('expiredCards').textContent = data.stats.expired || 0;
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            });
    }

    // åŠ è½½å¡å¯†åˆ—è¡¨
    function loadCardList(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('searchInput').value;
        
        const params = new URLSearchParams({
            page: page,
            per_page: perPage,
            search: searchTerm
        });

        fetch(`/admin/api/cards?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allCards = data.data;
                    filteredCards = allCards;
                    renderCardList(data.data);
                    renderPagination(data.pagination);
                    updateBatchDeleteButton();
                } else {
                    showToast(data.message || 'åŠ è½½å¡å¯†åˆ—è¡¨å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åŠ è½½å¡å¯†åˆ—è¡¨å¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
    }

    // æ¸²æŸ“å¡å¯†åˆ—è¡¨
    function renderCardList(cards) {
        const tbody = document.getElementById('cardListBody');
        
        if (cards.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 40px; color: #6b7280;">
                        æš‚æ— å¡å¯†æ•°æ®
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = cards.map((card, index) => `
            <tr>
                <td>
                    <input type="checkbox" class="card-checkbox" value="${card.id}" 
                           onchange="toggleCardSelection(${card.id})" 
                           ${selectedCards.has(card.id) ? 'checked' : ''}>
                </td>
                <td>${index + 1 + (currentPage - 1) * perPage}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                            ${card.card_key}
                        </code>
                        <button class="btn btn-sm" onclick="copyToClipboard('${card.card_key}')" 
                                title="å¤åˆ¶å¡å¯†" style="padding: 2px 6px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ“‹
                        </button>
                    </div>
                </td>
                <td>${card.used_count}/${card.usage_limit}</td>
                <td>${card.last_used_at ? formatDateTime(card.last_used_at) : '-'}</td>
                <td>${formatExpirationDisplay(card.expired_at)}</td>
                <td>${getBoundEmailInfo(card) || '-'}</td>
                <td>
                    <div style="font-size: 12px;">
                        <div>æ”¶å–: ${card.email_days_filter || 1}å¤©å†…</div>
                        ${card.keyword_filter ? `<div>å…³é”®è¯: ${card.keyword_filter.substring(0, 20)}${card.keyword_filter.length > 20 ? '...' : ''}</div>` : '<div>å…³é”®è¯: ä¸é™åˆ¶</div>'}
                    </div>
                </td>
                <td>${getCardRemarks(card.remarks) || '-'}</td>
                <td>${formatDateTime(card.created_at)}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="showEditModal(${card.id})" 
                                title="ç¼–è¾‘">âœï¸</button>
                        <button class="btn btn-sm btn-success" onclick="apiPickup('${card.card_key}')" 
                                title="APIå–ä»¶">ğŸ“¥</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})" 
                                title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('å¡å¯†å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('å¡å¯†å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } catch (err) {
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        }
        document.body.removeChild(textArea);
    }

    // ä»å¡å¯†æ•°æ®ä¸­è·å–ç»‘å®šé‚®ç®±ä¿¡æ¯
    function getBoundEmailInfo(card) {
        // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„bound_emailå­—æ®µï¼ˆå®é™…é‚®ç®±åœ°å€ï¼‰
        if (card.bound_email) {
            return card.bound_email;
        }
        
        // å…¼å®¹æ€§ï¼šå¦‚æœæœ‰ç»‘å®šé‚®ç®±IDä½†æ²¡æœ‰é‚®ç®±åœ°å€ï¼Œå°è¯•ä»ä¸‹æ‹‰æ¡†ä¸­æŸ¥æ‰¾
        if (card.bound_email_id) {
            const emailSelect = document.getElementById('emailSelect');
            if (emailSelect) {
                for (let option of emailSelect.options) {
                    if (option.value == card.bound_email_id) {
                        return option.textContent.split(' ')[0]; // åªè¿”å›é‚®ç®±åœ°å€éƒ¨åˆ†
                    }
                }
            }
            return `é‚®ç®±ID: ${card.bound_email_id}`;
        }
        
        // å…¼å®¹æ—§ç‰ˆæœ¬çš„å¤‡æ³¨ç»‘å®šæ–¹å¼
        return getBoundEmail(card.remarks);
    }

    // ä»å¤‡æ³¨ä¸­æå–ç»‘å®šé‚®ç®±
    function getBoundEmail(remarks) {
        if (!remarks) return '';
        const match = remarks.match(/ç»‘å®šé‚®ç®±:\s*([^\s,ï¼Œï¼›;]+)/);
        return match ? match[1] : '';
    }

    // ä»å¤‡æ³¨ä¸­æå–å®é™…å¤‡æ³¨å†…å®¹ï¼ˆæ’é™¤ç»‘å®šé‚®ç®±éƒ¨åˆ†ï¼‰
    function getCardRemarks(remarks) {
        if (!remarks) return '';
        // å¦‚æœåŒ…å«ç»‘å®šé‚®ç®±ä¿¡æ¯ï¼Œåˆ™æå–å…¶ä»–éƒ¨åˆ†
        if (remarks.includes('ç»‘å®šé‚®ç®±:')) {
            return remarks.replace(/ç»‘å®šé‚®ç®±:\s*[^\s,ï¼Œï¼›;]+\s*[,ï¼Œï¼›;]?\s*/, '').trim();
        }
        return remarks;
    }
    function getStatusBadge(card) {
        const now = new Date();
        const expiredAt = card.expired_at ? new Date(card.expired_at) : null;
        
        if (card.status === 0) {
            return '<span class="status-badge status-disabled">å·²ç¦ç”¨</span>';
        }
        
        if (expiredAt && expiredAt < now) {
            return '<span class="status-badge status-expired">å·²è¿‡æœŸ</span>';
        }
        
        if (card.used_count >= card.usage_limit) {
            return '<span class="status-badge status-used">å·²ç”¨å®Œ</span>';
        }
        
        return '<span class="status-badge status-active">å¯ç”¨</span>';
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        
        // ç°åœ¨æ•°æ®åº“å·²ç»å­˜å‚¨åŒ—äº¬æ—¶é—´ï¼Œç›´æ¥è§£æå¹¶æ ¼å¼åŒ–å³å¯
        let date;
        if (dateString.includes('T')) {
            // ISOæ ¼å¼ï¼š2023-12-01T10:30:00Z æˆ– 2023-12-01T10:30:00
            date = new Date(dateString);
        } else if (dateString.includes(' ')) {
            // MySQLæ ¼å¼ï¼š2023-12-01 10:30:00
            // æ•°æ®åº“ç°åœ¨å­˜å‚¨çš„æ˜¯åŒ—äº¬æ—¶é—´ï¼Œç›´æ¥è§£æ
            date = new Date(dateString);
        } else {
            // å…¶ä»–æ ¼å¼
            date = new Date(dateString);
        }
        
        // æ ¼å¼åŒ–ä¸ºä¸­æ–‡æ—¥æœŸæ—¶é—´æ ¼å¼
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        totalPages = pagination.pages;
        
        let html = `<div class="pagination-info">å…± ${pagination.total} æ¡è®°å½•ï¼Œç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.pages} é¡µ</div>`;
        
        if (pagination.pages > 1) {
            html += '<div class="pagination-buttons">';
            
            // ä¸Šä¸€é¡µ
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="loadCardList(${pagination.page - 1})">Â« ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.pages, pagination.page + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="loadCardList(1)">1</button>`;
                if (startPage > 2) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadCardList(${i})">${i}</button>`;
            }
            
            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
                html += `<button class="page-btn" onclick="loadCardList(${pagination.pages})">${pagination.pages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="loadCardList(${pagination.page + 1})">ä¸‹ä¸€é¡µ Â»</button>`;
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
    }

    // æœç´¢å¡å¯†
    function searchCards() {
        loadCardList(1);
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        loadCardList(1);
    }

    // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
    function changePerPage() {
        const select = document.getElementById('perPageSelect');
        perPage = parseInt(select.value);
        loadCardList(1);
    }

    // åˆ·æ–°å¡å¯†åˆ—è¡¨
    function refreshCardList() {
        selectedCards.clear();
        loadCardStats();
        loadCardList(currentPage);
    }

    // åˆ‡æ¢å•ä¸ªå¡å¯†é€‰æ‹©
    function toggleCardSelection(cardId) {
        if (selectedCards.has(cardId)) {
            selectedCards.delete(cardId);
        } else {
            selectedCards.add(cardId);
        }
        updateSelectAllCheckbox();
        updateBatchDeleteButton();
    }

    // åˆ‡æ¢å…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.card-checkbox');
        
        selectedCards.clear();
        
        if (selectAll.checked) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedCards.add(parseInt(checkbox.value));
            });
        } else {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        updateBatchDeleteButton();
    }

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    function updateSelectAllCheckbox() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.card-checkbox');
        const checkedCount = document.querySelectorAll('.card-checkbox:checked').length;
        
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        selectAll.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®æ˜¾ç¤º
    function updateBatchDeleteButton() {
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        if (selectedCards.size > 0) {
            batchDeleteBtn.style.display = 'inline-block';
            batchDeleteBtn.innerHTML = `<i>ğŸ—‘ï¸</i> æ‰¹é‡åˆ é™¤ (${selectedCards.size})`;
        } else {
            batchDeleteBtn.style.display = 'none';
        }
    }

    // æ˜¾ç¤ºç”Ÿæˆå¡å¯†å¼¹çª—
    function showGenerateModal() {
        document.getElementById('generateForm').reset();
        document.getElementById('generateModal').classList.add('show');
    }

    // æ˜¾ç¤ºæ‰¹é‡ç”Ÿæˆå¡å¯†å¼¹çª—
    function showBatchGenerateModal() {
        document.getElementById('batchGenerateForm').reset();
        document.getElementById('batchGenerateModal').classList.add('show');
    }

    // å…³é—­å¼¹çª—
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // ç”Ÿæˆå•ä¸ªå¡å¯†
    function generateCard() {
        const form = document.getElementById('generateForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'generate',
            usage_limit: parseInt(formData.get('usage_limit')),
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || '',
            expired_at: expired_at,
            remarks: formData.get('remarks') || ''
        };

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('generateModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('ç”Ÿæˆå¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // æ‰¹é‡ç”Ÿæˆå¡å¯†
    function batchGenerateCards() {
        const form = document.getElementById('batchGenerateForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'batch_generate',
            count: parseInt(formData.get('count')),
            usage_limit: parseInt(formData.get('usage_limit')),
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || '',
            expired_at: expired_at,
            remarks: formData.get('remarks') || ''
        };

        if (data.count > 100) {
            showToast('ä¸€æ¬¡æœ€å¤šç”Ÿæˆ100ä¸ªå¡å¯†', 'error');
            return;
        }

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('batchGenerateModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ‰¹é‡ç”Ÿæˆå¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // åˆ é™¤å•ä¸ªå¡å¯†
    function deleteCard(cardId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        fetch('/admin/api/cards', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: cardId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å¡å¯†åˆ é™¤æˆåŠŸ', 'success');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('åˆ é™¤å¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // æ‰¹é‡åˆ é™¤å¡å¯†
    function batchDeleteCards() {
        if (selectedCards.size === 0) {
            showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„å¡å¯†', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCards.size} ä¸ªå¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            return;
        }

        fetch('/admin/api/cards', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                action: 'batch_delete',
                ids: Array.from(selectedCards) 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                selectedCards.clear();
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ‰¹é‡åˆ é™¤å¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // ç”Ÿæˆå¡å¯†API
    function generateCardAPI() {
        const cardKey = document.getElementById('editCardKey').value;
        if (!cardKey) {
            showToast('è¯·å…ˆé€‰æ‹©å¡å¯†', 'error');
            return;
        }

        // ç”ŸæˆAPIé¡µé¢é“¾æ¥
        const apiUrl = `${window.location.origin}/admin/api/cards/generate-api/${cardKey}`;
        
        // æ‰“å¼€APIé¡µé¢
        window.open(apiUrl, '_blank');
        
        // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
        copyToClipboard(apiUrl);
        
        showToast('APIé¡µé¢å·²æ‰“å¼€ï¼Œé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // åŠ è½½é‚®ç®±åˆ—è¡¨ï¼ˆç”¨äºç»‘å®šï¼‰- æ›´æ–°ä¸ºåªè·å–æœªç»‘å®šçš„é‚®ç®±
    function loadEmailList(callback) {
        // å¯¹äºç¼–è¾‘æ¨¡å¼ï¼Œéœ€è¦è·å–å½“å‰å¡å¯†å¯ç»‘å®šçš„é‚®ç®±
        const cardId = document.getElementById('editCardId').value;
        
        if (cardId) {
            // ç¼–è¾‘æ¨¡å¼ï¼šè·å–å¯ç»‘å®šçš„é‚®ç®±
            fetch(`/admin/api/cards/${cardId}/available-emails`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateEmailSelectOptions(data.data);
                        if (callback) callback();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¯ç»‘å®šé‚®ç®±åˆ—è¡¨å¤±è´¥:', error);
                    if (callback) callback();
                });
        } else {
            // æ·»åŠ æ¨¡å¼ï¼šè·å–æ‰€æœ‰æœªç»‘å®šçš„é‚®ç®±
            fetch('/admin/api/mailbox?per_page=100')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateEmailSelectOptions(data.data);
                        if (callback) callback();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é‚®ç®±åˆ—è¡¨å¤±è´¥:', error);
                    if (callback) callback();
                });
        }
    }
    
    // æ›´æ–°é‚®ç®±é€‰æ‹©å™¨é€‰é¡¹
    function updateEmailSelectOptions(emails) {
        // æ›´æ–°ç»‘å®šé‚®ç®±å¼¹çª—ä¸­çš„é€‰æ‹©å™¨
        const bindEmailSelect = document.getElementById('emailSelect');
        if (bindEmailSelect) {
            bindEmailSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é‚®ç®±è´¦å·</option>';
            emails.forEach(email => {
                const option = document.createElement('option');
                option.value = email.id;
                option.textContent = `${email.email} (${email.server})`;
                bindEmailSelect.appendChild(option);
            });
        }
        
        // æ›´æ–°ç¼–è¾‘å¼¹çª—ä¸­çš„é€‰æ‹©å™¨
        const editEmailSelect = document.getElementById('editBoundEmailId');
        if (editEmailSelect) {
            const currentValue = editEmailSelect.value; // ä¿å­˜å½“å‰å€¼
            editEmailSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é‚®ç®±è´¦å·</option>';
            emails.forEach(email => {
                const option = document.createElement('option');
                option.value = email.id;
                option.textContent = `${email.email} (${email.server})`;
                editEmailSelect.appendChild(option);
            });
            // æ¢å¤å½“å‰å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
            if (currentValue) {
                editEmailSelect.value = currentValue;
            }
        }
    }

    // æ˜¾ç¤ºç¼–è¾‘å¡å¯†å¼¹çª—
    function showEditModal(cardId) {
        // ä»å½“å‰åŠ è½½çš„å¡å¯†åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å¡å¯†
        const card = allCards.find(c => c.id === cardId);
        if (!card) {
            showToast('å¡å¯†ä¿¡æ¯æœªæ‰¾åˆ°', 'error');
            return;
        }
        
        document.getElementById('editCardId').value = card.id;
        document.getElementById('editCardKey').value = card.card_key;
        document.getElementById('editUsageLimit').value = card.usage_limit || 1;
        document.getElementById('editExpiredAt').value = card.expired_at || '';
        document.getElementById('editRemarks').value = getCardRemarks(card.remarks) || '';
        document.getElementById('editBoundEmailId').value = card.bound_email_id || '';
        document.getElementById('editEmailDaysFilter').value = card.email_days_filter || 1;
        document.getElementById('editKeywordFilter').value = card.keyword_filter || '';
        
        // ç¡®ä¿é‚®ç®±é€‰æ‹©å™¨å·²åŠ è½½
        loadEmailList(function() {
            document.getElementById('editModal').classList.add('show');
        });
    }

    // ä¿å­˜ç¼–è¾‘
    function saveEdit() {
        const form = document.getElementById('editForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'edit',
            card_id: parseInt(formData.get('card_id')),
            usage_limit: parseInt(formData.get('usage_limit')),
            expired_at: expired_at,
            remarks: formData.get('remarks') || '',
            bound_email_id: formData.get('bound_email_id') ? parseInt(formData.get('bound_email_id')) : null,
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || ''
        };

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('editModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('ç¼–è¾‘å¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ç”¨äºè¾“å…¥æ¡†ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    function formatDateTimeForInput(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
        const beijingDate = new Date(date.toLocaleString('en-US', {timeZone: 'Asia/Shanghai'}));
        const year = beijingDate.getFullYear();
        const month = String(beijingDate.getMonth() + 1).padStart(2, '0');
        const day = String(beijingDate.getDate()).padStart(2, '0');
        const hours = String(beijingDate.getHours()).padStart(2, '0');
        const minutes = String(beijingDate.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    function showBindEmailModal(cardId, cardKey) {
        document.getElementById('bindCardId').value = cardId;
        document.getElementById('bindCardKey').value = cardKey;
        document.getElementById('bindEmailModal').classList.add('show');
    }

    // ç»‘å®šé‚®ç®±
    function bindEmail() {
        const form = document.getElementById('bindEmailForm');
        const formData = new FormData(form);
        
        const data = {
            action: 'bind_email',
            card_id: parseInt(formData.get('card_id')),
            email_id: parseInt(formData.get('email_id'))
        };

        if (!data.email_id) {
            showToast('è¯·é€‰æ‹©é‚®ç®±è´¦å·', 'error');
            return;
        }

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('bindEmailModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('ç»‘å®šé‚®ç®±å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // APIå–ä»¶ - å¤åˆ¶APIé“¾æ¥
    function apiPickup(cardKey) {
        // ç”ŸæˆAPIé¡µé¢é“¾æ¥
        const apiUrl = `${window.location.origin}/admin/api/cards/generate-api/${cardKey}`;
        
        // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
        copyToClipboard(apiUrl);
        
        showToast('APIé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });

    // ========== å›æ”¶ç«™åŠŸèƒ½ ==========
    
    let currentRecycleBinTab = 'deleted';
    
    // æ˜¾ç¤ºå›æ”¶ç«™å¼¹çª—
    function showRecycleBinModal() {
        currentRecycleBinTab = 'deleted';
        document.getElementById('recycleBinModal').classList.add('show');
        loadRecycleBinData();
    }
    
    // åˆ‡æ¢å›æ”¶ç«™æ ‡ç­¾
    function switchRecycleBinTab(tab) {
        currentRecycleBinTab = tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('deletedTabBtn').style.opacity = tab === 'deleted' ? '1' : '0.6';
        document.getElementById('expiredTabBtn').style.opacity = tab === 'expired' ? '1' : '0.6';
        
        // æ˜¾ç¤ºå¯¹åº”å†…å®¹
        document.getElementById('deletedCardsContent').style.display = tab === 'deleted' ? 'block' : 'none';
        document.getElementById('expiredCardsContent').style.display = tab === 'expired' ? 'block' : 'none';
        
        loadRecycleBinData();
    }
    
    // åŠ è½½å›æ”¶ç«™æ•°æ®
    function loadRecycleBinData() {
        const loading = document.getElementById('recycleBinLoading');
        loading.style.display = 'block';
        
        fetch(`/admin/api/recycle-bin?type=${currentRecycleBinTab}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderRecycleBinData(data.data, currentRecycleBinTab);
                    updateRecycleBinCounts(data.counts);
                } else {
                    showToast(data.message || 'åŠ è½½å›æ”¶ç«™æ•°æ®å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åŠ è½½å›æ”¶ç«™æ•°æ®å¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            })
            .finally(() => {
                loading.style.display = 'none';
            });
    }
    
    // æ¸²æŸ“å›æ”¶ç«™æ•°æ®
    function renderRecycleBinData(cards, type) {
        const bodyId = type === 'deleted' ? 'deletedCardsBody' : 'expiredCardsBody';
        const tbody = document.getElementById(bodyId);
        
        if (cards.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                        æš‚æ— ${type === 'deleted' ? 'å·²åˆ é™¤' : 'å·²è¿‡æœŸ'}çš„å¡å¯†
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = cards.map((card, index) => `
            <tr>
                <td>
                    <input type="checkbox" class="recycle-checkbox recycle-checkbox-${type}" 
                           value="${card.id}" onchange="toggleRecycleItemSelection('${type}')">
                </td>
                <td>${index + 1}</td>
                <td>
                    <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                        ${card.card_key}
                    </code>
                </td>
                <td>${card.used_count}/${card.usage_limit}</td>
                <td>${formatDateTime(type === 'deleted' ? card.deleted_at : card.expired_at)}</td>
                <td>${card.reason || (type === 'deleted' ? 'æ‰‹åŠ¨åˆ é™¤' : 'è‡ªåŠ¨è¿‡æœŸ')}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-sm btn-success" onclick="restoreCard(${card.id}, '${type}')" 
                                title="æ¢å¤">ğŸ”„</button>
                        <button class="btn btn-sm btn-danger" onclick="permanentDeleteCard(${card.id}, '${type}')" 
                                title="æ°¸ä¹…åˆ é™¤">âŒ</button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Reset selection state when data is refreshed
        updateRecycleBatchActions(type);
    }
    
    // æ›´æ–°å›æ”¶ç«™è®¡æ•°
    function updateRecycleBinCounts(counts) {
        document.getElementById('deletedCount').textContent = counts.deleted || 0;
        document.getElementById('expiredCount').textContent = counts.expired || 0;
    }
    
    // æ¢å¤å¡å¯†
    function restoreCard(cardId, type) {
        if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªå¡å¯†å—ï¼Ÿæ¢å¤åå°†é‡æ–°å‡ºç°åœ¨å¡å¯†åˆ—è¡¨ä¸­ã€‚')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_id: cardId,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å¡å¯†æ¢å¤æˆåŠŸ', 'success');
                loadRecycleBinData();
                refreshCardList(); // åˆ·æ–°ä¸»åˆ—è¡¨
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ¢å¤å¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // æ°¸ä¹…åˆ é™¤å¡å¯†
    function permanentDeleteCard(cardId, type) {
        if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªå¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/permanent-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_id: cardId,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å¡å¯†æ°¸ä¹…åˆ é™¤æˆåŠŸ', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ°¸ä¹…åˆ é™¤å¡å¯†å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // æ¸…ç©ºå›æ”¶ç«™
    function clearRecycleBin() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªå›æ”¶ç«™å—ï¼Ÿæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å›æ”¶ç«™ä¸­çš„å¡å¯†ï¼Œä¸å¯æ¢å¤ï¼')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/clear', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('å›æ”¶ç«™æ¸…ç©ºæˆåŠŸ', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ¸…ç©ºå›æ”¶ç«™å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // ========== å›æ”¶ç«™å¤šé€‰åŠŸèƒ½ ==========
    
    // åˆ‡æ¢å›æ”¶ç«™é¡¹ç›®é€‰æ‹©çŠ¶æ€
    function toggleRecycleItemSelection(type) {
        updateRecycleBatchActions(type);
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰å›æ”¶ç«™é¡¹ç›®
    function toggleSelectAllRecycleItems(type) {
        const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}`);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateRecycleBatchActions(type);
    }
    
    // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
    function updateRecycleBatchActions(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}`);
        const checkedCount = document.querySelectorAll(`.recycle-checkbox-${type}:checked`).length;
        const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        
        // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        selectAll.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        
        // æ˜¾ç¤º/éšè—æ‰¹é‡æ“ä½œæŒ‰é’®
        const batchActions = document.getElementById(`${type}BatchActions`);
        const restoreBtn = document.getElementById(`batchRestore${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
        const deleteBtn = document.getElementById(`batchDelete${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
        
        if (checkedCount > 0) {
            batchActions.style.display = 'block';
            restoreBtn.textContent = `ğŸ”„ æ‰¹é‡æ¢å¤ (${checkedCount})`;
            deleteBtn.textContent = `ğŸ—‘ï¸ æ‰¹é‡æ°¸ä¹…åˆ é™¤ (${checkedCount})`;
        } else {
            batchActions.style.display = 'none';
        }
    }
    
    // æ‰¹é‡æ¢å¤å›æ”¶ç«™é¡¹ç›®
    function batchRestoreRecycleItems(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}:checked`);
        const cardIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (cardIds.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©è¦æ¢å¤çš„å¡å¯†', 'warning');
            return;
        }
        
        const typeText = type === 'deleted' ? 'å·²åˆ é™¤' : 'å·²è¿‡æœŸ';
        if (!confirm(`ç¡®å®šè¦æ‰¹é‡æ¢å¤é€‰ä¸­çš„ ${cardIds.length} ä¸ª${typeText}å¡å¯†å—ï¼Ÿæ¢å¤åå°†é‡æ–°å‡ºç°åœ¨å¡å¯†åˆ—è¡¨ä¸­ã€‚`)) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_ids: cardIds,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('æ‰¹é‡æ¢å¤æˆåŠŸ', 'success');
                loadRecycleBinData();
                refreshCardList();
            } else {
                showToast(data.message || 'æ‰¹é‡æ¢å¤å¤±è´¥', 'error');
            }
        })
        .catch(error => {
            console.error('æ‰¹é‡æ¢å¤å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // æ‰¹é‡æ°¸ä¹…åˆ é™¤å›æ”¶ç«™é¡¹ç›®
    function batchPermanentDeleteRecycleItems(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}:checked`);
        const cardIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (cardIds.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¡å¯†', 'warning');
            return;
        }
        
        const typeText = type === 'deleted' ? 'å·²åˆ é™¤' : 'å·²è¿‡æœŸ';
        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${cardIds.length} ä¸ª${typeText}å¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/permanent-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_ids: cardIds,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            }
        })
        .catch(error => {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
</script>
{% endblock %}