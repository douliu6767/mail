{% extends "base.html" %}

{% block title %}卡密管理 - {{ system_title }}{% endblock %}

{% block head %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --sidebar-width: 280px;
        --header-height: 70px;
        --transition: all 0.3s ease;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        line-height: 1.6;
        color: #334155;
        transition: var(--transition);
    }
    
    /* Sidebar Styles */
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        z-index: 1000;
        transition: var(--transition);
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-logo {
        color: white;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .sidebar-nav {
        padding: 20px 0;
    }
    
    .nav-item {
        display: block;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        padding: 15px 25px;
        transition: var(--transition);
        border-left: 3px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.1);
        transform: translateX(-100%);
        transition: var(--transition);
    }
    
    .nav-item:hover::before {
        transform: translateX(0);
    }
    
    .nav-item:hover,
    .nav-item.active {
        color: white;
        background: rgba(255,255,255,0.15);
        border-left-color: white;
        transform: translateX(5px);
    }
    
    .nav-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* Main Content */
    .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        transition: var(--transition);
    }
    
    .header {
        background: white;
        height: var(--header-height);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        position: sticky;
        top: 0;
        z-index: 999;
    }
    
    .header-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: #64748b;
    }
    
    .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
    }
    
    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    /* Content Area */
    .content {
        padding: 30px;
    }
    
    /* Cards */
    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 25px;
        transition: var(--transition);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
    }
    
    .card-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .card-body {
        padding: 25px;
    }
    
    /* Buttons */
    .btn {
        display: inline-block;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        transform: translateY(-2px);
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    /* Search Controls Styles */
    .search-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: nowrap; /* Prevent wrapping unless specifically needed */
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 550px; /* Increased from 400px for longer search box */
        min-width: 0; /* Allow shrinking */
    }
    
    .search-box input {
        flex: 1;
        min-width: 200px; /* Increased from 150px for better appearance */
        padding: 10px 16px; /* Enhanced padding for better visual appeal */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 1px 3px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .search-box input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }
    
    .page-controls select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    
    /* Table */
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    .table th {
        background: #f8fafc;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: #f9fafb;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-active {
        background: #dcfce7;
        color: #166534;
    }
    
    .status-used {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-expired {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-disabled {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    /* Pagination */
    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .pagination-info {
        color: #6b7280;
        font-size: 14px;
        margin-right: 20px;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #374151;
        text-decoration: none;
        border-radius: 6px;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .page-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }
    
    .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #f1f5f9;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    /* Form */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    /* Checkbox */
    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .form-check input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
    }
    
    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-align: center;
        border-left: 4px solid var(--primary-color);
    }
    
    .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6b7280;
    }
    
    /* Loading */
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid #f3f4f6;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
    }
    
    .toast {
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transform: translateX(450px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        background: #6b7280;
        margin-bottom: 10px;
    }
    
    .toast.show {
        transform: translateX(0);
        opacity: 1;
    }
    
    .toast.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .toast.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .toast.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    /* Alert (deprecated - replaced by toast) */
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid;
    }
    
    .alert-success {
        background: #f0fdf4;
        border-color: #22c55e;
        color: #166534;
    }
    
    .alert-error {
        background: #fef2f2;
        border-color: #ef4444;
        color: #991b1b;
    }
    
    .alert-info {
        background: #f0f9ff;
        border-color: #3b82f6;
        color: #1e40af;
    }
    
    /* Mobile menu toggle - default hidden */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
        transition: var(--transition);
    }
    
    .mobile-menu-toggle:hover {
        color: var(--primary-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .header-title {
            font-size: 20px;
        }
        
        .content {
            padding: 20px;
        }
        
        .mobile-menu-toggle {
            display: block !important;
        }
        
        .card-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        .modal-content {
            width: 95%;
            margin: 20px;
        }
        
        .table-container {
            font-size: 12px;
        }
    }
    
    /* Mobile overlay */
    .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    
    .mobile-overlay.show {
        display: block;
    }
</style>
{% endblock %}

{% block body %}
<!-- Toast notification container -->
<div id="toast-container" class="toast-container"></div>

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">📧 邮件管理系统</div>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('admin_home') }}" class="nav-item">
            <i>🏠</i> 首页
        </a>
        <a href="{{ url_for('admin_mailbox') }}" class="nav-item">
            <i>📫</i> 邮箱管理
        </a>
        <a href="{{ url_for('admin_daili') }}" class="nav-item">
            <i>🌐</i> 代理池
        </a>
        <a href="{{ url_for('admin_kami') }}" class="nav-item active">
            <i>🔑</i> 卡密管理
        </a>
        <a href="{{ url_for('admin_kamirizhi') }}" class="nav-item">
            <i>📝</i> 卡密日志
        </a>
        <a href="{{ url_for('admin_shoujian') }}" class="nav-item">
            <i>📧</i> 收件日志
        </a>
        <a href="{{ url_for('admin_system') }}" class="nav-item">
            <i>⚙️</i> 系统设置
        </a>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
            <h1 class="header-title">卡密管理</h1>
        </div>
        <div class="header-actions">
            <div class="user-info">
                <span>欢迎，{{ admin_username }}</span>
            </div>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">退出登录</a>
        </div>
    </div>
    
    <div class="content">
        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCards">0</div>
                <div class="stat-label">总卡密数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCards">0</div>
                <div class="stat-label">可用卡密</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usedCards">0</div>
                <div class="stat-label">已使用</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiredCards">0</div>
                <div class="stat-label">已过期</div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">卡密管理</h2>
            </div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showGenerateModal()">
                        <i>➕</i> 生成卡密
                    </button>
                    <button class="btn btn-success" onclick="showBatchGenerateModal()">
                        <i>📦</i> 批量生成卡密
                    </button>
                    <button class="btn btn-secondary" onclick="showRecycleBinModal()">
                        <i>🗑️</i> 回收站
                    </button>
                    <button class="btn btn-danger" onclick="batchDeleteCards()" style="display: none;" id="batchDeleteBtn">
                        <i>🗑️</i> 批量删除
                    </button>
                    <button class="btn btn-secondary" onclick="refreshCardList()">
                        <i>🔄</i> 刷新
                    </button>
                </div>

                <!-- 搜索和分页控制 -->
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜索卡密..." onkeyup="searchCards()">
                        <button class="btn btn-primary" onclick="searchCards()">🔍 搜索</button>
                        <button class="btn btn-danger" onclick="clearSearch()">🗑️ 清除</button>
                    </div>
                    <div class="page-controls">
                        <select id="perPageSelect" onchange="changePerPage()">
                            <option value="10">每页10条</option>
                            <option value="20" selected>每页20条</option>
                            <option value="50">每页50条</option>
                        </select>
                    </div>
                </div>

                <!-- 卡密列表 -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>序号ID</th>
                                <th>卡密</th>
                                <th>使用次数</th>
                                <th>使用时间</th>
                                <th>过期时间</th>
                                <th>绑定邮箱</th>
                                <th>邮件过滤</th>
                                <th>备注</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cardListBody">
                            <tr>
                                <td colspan="10" class="loading">
                                    <div class="spinner"></div>
                                    <div>加载中...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页导航 -->
                <div class="pagination-container" id="paginationContainer">
                    <!-- 分页按钮将通过JavaScript生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 生成卡密弹窗 -->
    <div id="generateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">生成卡密</h3>
                <button class="modal-close" onclick="closeModal('generateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="generateForm">
                    <div class="form-group">
                        <label class="form-label">使用次数限制</label>
                        <input type="number" class="form-control" name="usage_limit" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">收取X天内的邮件</label>
                        <input type="number" class="form-control" name="email_days_filter" value="1" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label class="form-label">关键词邮件</label>
                        <input type="text" class="form-control" name="keyword_filter" placeholder="设置关键词后只收取标题包含关键词的邮件，多个关键词用逗号分隔">
                        <small style="color: #6b7280;">留空则不限制关键词</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">过期时间</label>
                        <input type="text" class="form-control" name="expired_at" placeholder="支持格式：1、7、30、100 或 1天、7天、30天 或具体日期时间">
                        <small style="color: #6b7280;">支持格式：数字天数（如：1、100）、天数+天字（如：1天、7天）或具体日期时间，留空则永不过期，使用北京时间</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <input type="text" class="form-control" name="remarks" placeholder="卡密用途说明">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('generateModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="generateCard()">生成卡密</button>
            </div>
        </div>
    </div>

    <!-- 批量生成卡密弹窗 -->
    <div id="batchGenerateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">批量生成卡密</h3>
                <button class="modal-close" onclick="closeModal('batchGenerateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="batchGenerateForm">
                    <div class="form-group">
                        <label class="form-label">生成数量</label>
                        <input type="number" class="form-control" name="count" value="10" min="1" max="100" required>
                        <small style="color: #6b7280;">最多一次生成100个</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">使用次数限制</label>
                        <input type="number" class="form-control" name="usage_limit" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">收取X天内的邮件</label>
                        <input type="number" class="form-control" name="email_days_filter" value="1" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label class="form-label">关键词邮件</label>
                        <input type="text" class="form-control" name="keyword_filter" placeholder="设置关键词后只收取标题包含关键词的邮件，多个关键词用逗号分隔">
                        <small style="color: #6b7280;">留空则不限制关键词</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">过期时间</label>
                        <input type="text" class="form-control" name="expired_at" placeholder="支持格式：1、7、30、100 或 1天、7天、30天 或具体日期时间">
                        <small style="color: #6b7280;">支持格式：数字天数（如：1、100）、天数+天字（如：1天、7天）或具体日期时间，留空则永不过期，使用北京时间</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <input type="text" class="form-control" name="remarks" placeholder="批量卡密用途说明">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('batchGenerateModal')">取消</button>
                <button type="button" class="btn btn-success" onclick="batchGenerateCards()">批量生成</button>
            </div>
        </div>
    </div>

    <!-- 绑定邮箱弹窗 -->
    <div id="bindEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">绑定邮箱</h3>
                <button class="modal-close" onclick="closeModal('bindEmailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bindEmailForm">
                    <input type="hidden" name="card_id" id="bindCardId">
                    <div class="form-group">
                        <label class="form-label">选择邮箱</label>
                        <select class="form-control" name="email_id" id="emailSelect" required>
                            <option value="">请选择邮箱账号</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">卡密</label>
                        <input type="text" class="form-control" id="bindCardKey" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bindEmailModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="bindEmail()">绑定</button>
            </div>
        </div>
    </div>

    <!-- 编辑卡密弹窗 -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">编辑卡密</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="card_id" id="editCardId">
                    
                    <div class="form-group">
                        <label class="form-label">卡密</label>
                        <input type="text" class="form-control" id="editCardKey" readonly>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">绑定邮箱</label>
                            <select class="form-control" name="bound_email_id" id="editBoundEmailId">
                                <option value="">请选择邮箱账号</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">收取X天内的邮件</label>
                            <input type="number" class="form-control" name="email_days_filter" id="editEmailDaysFilter" value="1" min="1" max="365">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">关键词邮件</label>
                        <input type="text" class="form-control" name="keyword_filter" id="editKeywordFilter" placeholder="设置关键词后只收取标题包含关键词的邮件，多个关键词用逗号分隔">
                        <small style="color: #6b7280;">留空则不限制关键词</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">使用次数限制</label>
                            <input type="number" class="form-control" name="usage_limit" id="editUsageLimit" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">过期时间</label>
                            <input type="text" class="form-control" name="expired_at" id="editExpiredAt" placeholder="支持格式：1、7、30、100 或 1天、7天、30天 或具体日期时间">
                            <small style="color: #6b7280;">支持格式：数字天数（如：1、100）、天数+天字（如：1天、7天）或具体日期时间，留空则永不过期，使用北京时间</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <input type="text" class="form-control" name="remarks" id="editRemarks" placeholder="卡密用途说明">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">取消</button>
                <button type="button" class="btn btn-success" onclick="generateCardAPI()">生成API</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 回收站弹窗 -->
    <div id="recycleBinModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title">🗑️ 卡密回收站</h3>
                <button class="modal-close" onclick="closeModal('recycleBinModal')">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <!-- 分类标签 -->
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-sm" id="deletedTabBtn" onclick="switchRecycleBinTab('deleted')" 
                            style="background: #ef4444; color: white; margin-right: 10px;">
                        已删除的卡密 (<span id="deletedCount">0</span>)
                    </button>
                    <button class="btn btn-sm" id="expiredTabBtn" onclick="switchRecycleBinTab('expired')" 
                            style="background: #f59e0b; color: white;">
                        已过期的卡密 (<span id="expiredCount">0</span>)
                    </button>
                </div>
                
                <!-- 回收站内容 -->
                <div id="recycleBinContent">
                    <div class="loading" id="recycleBinLoading">
                        <div class="spinner"></div>
                        <div>加载中...</div>
                    </div>
                    
                    <!-- 已删除的卡密 -->
                    <div id="deletedCardsContent" style="display: none;">
                        <h4 style="color: #ef4444; margin-bottom: 15px;">已删除的卡密</h4>
                        <div id="deletedBatchActions" style="margin-bottom: 10px; display: none;">
                            <button class="btn btn-primary btn-sm" onclick="batchRestoreRecycleItems('deleted')" id="batchRestoreDeletedBtn">
                                🔄 批量恢复 (0)
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="batchPermanentDeleteRecycleItems('deleted')" id="batchDeleteDeletedBtn">
                                🗑️ 批量永久删除 (0)
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllDeleted" onchange="toggleSelectAllRecycleItems('deleted')">
                                        </th>
                                        <th>序号</th>
                                        <th>卡密</th>
                                        <th>使用次数</th>
                                        <th>删除时间</th>
                                        <th>删除原因</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedCardsBody">
                                    <!-- 动态内容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 已过期的卡密 -->
                    <div id="expiredCardsContent" style="display: none;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px;">已过期的卡密</h4>
                        <div id="expiredBatchActions" style="margin-bottom: 10px; display: none;">
                            <button class="btn btn-primary btn-sm" onclick="batchRestoreRecycleItems('expired')" id="batchRestoreExpiredBtn">
                                🔄 批量恢复 (0)
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="batchPermanentDeleteRecycleItems('expired')" id="batchDeleteExpiredBtn">
                                🗑️ 批量永久删除 (0)
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllExpired" onchange="toggleSelectAllRecycleItems('expired')">
                                        </th>
                                        <th>序号</th>
                                        <th>卡密</th>
                                        <th>使用次数</th>
                                        <th>过期时间</th>
                                        <th>过期原因</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="expiredCardsBody">
                                    <!-- 动态内容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('recycleBinModal')">关闭</button>
                <button type="button" class="btn btn-danger" onclick="clearRecycleBin()">清空回收站</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mobile menu functionality
    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        if (sidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }
    
    function openMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.add('mobile-open');
        overlay.classList.add('show');
    }
    
    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
    }
    
    // Close mobile menu when clicking on navigation items
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                closeMobileMenu();
            });
        });
    });

    // 全局变量
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let selectedCards = new Set();
    let allCards = [];
    let filteredCards = [];

    // ========== 日期解析函数 ==========
    
    // 解析过期时间输入（支持"1天"、"7天"等格式）
    function parseExpirationInput(input) {
        if (!input || input.trim() === '') {
            return null; // 空值表示永不过期
        }
        
        input = input.trim();
        
        // 匹配纯数字（天数）：1、7、30、100等
        const numberMatch = input.match(/^(\d+)$/);
        if (numberMatch) {
            const days = parseInt(numberMatch[1]);
            // 使用北京时间 (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8小时的毫秒数
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' '); // MySQL datetime format
        }
        
        // 匹配中文天数格式：1天、7天、30天等
        const dayMatch = input.match(/^(\d+)天$/);
        if (dayMatch) {
            const days = parseInt(dayMatch[1]);
            // 使用北京时间 (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8小时的毫秒数
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' '); // MySQL datetime format
        }
        
        // 匹配其他可能的格式：1d、7d等
        const dayMatchEn = input.match(/^(\d+)d$/i);
        if (dayMatchEn) {
            const days = parseInt(dayMatchEn[1]);
            // 使用北京时间 (UTC+8)
            const now = new Date();
            const beijingOffset = 8 * 60 * 60 * 1000; // 8小时的毫秒数
            const beijingNow = new Date(now.getTime() + beijingOffset);
            const expirationDate = new Date(beijingNow.getTime() + days * 24 * 60 * 60 * 1000);
            return expirationDate.toISOString().slice(0, 19).replace('T', ' ');
        }
        
        // 尝试解析具体的日期时间格式
        try {
            // 支持 YYYY-MM-DD HH:mm:ss 格式
            if (input.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
                return input;
            }
            
            // 支持 YYYY-MM-DD HH:mm 格式
            if (input.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                return input + ':00';
            }
            
            // 支持 YYYY-MM-DD 格式（默认23:59:59）
            if (input.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return input + ' 23:59:59';
            }
            
            // 尝试解析其他格式并转换为标准格式
            const date = new Date(input);
            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }
            return date.toISOString().slice(0, 19).replace('T', ' ');
        } catch (e) {
            // 解析失败，返回错误信息
            throw new Error(`无法解析日期格式："${input}"。支持格式：数字天数（如：1、7、30、100）、天数+天字（如：1天、7天）或具体日期时间（如：YYYY-MM-DD HH:mm:ss）`);
        }
    }
    
    // 格式化过期时间显示（将数据库格式转换为易读格式）
    function formatExpirationDisplay(dateString) {
        if (!dateString) {
            return '永不过期';
        }
        
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `已过期 (${formatDateTime(dateString)})`;
            } else if (diffDays === 0) {
                return `今天过期 (${formatDateTime(dateString)})`;
            } else if (diffDays === 1) {
                return `明天过期 (${formatDateTime(dateString)})`;
            } else if (diffDays <= 30) {
                return `${diffDays}天后过期 (${formatDateTime(dateString)})`;
            } else {
                return formatDateTime(dateString);
            }
        } catch (e) {
            return dateString;
        }
    }

    // ========== 工具函数 ==========
    
    // Toast通知系统
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadCardStats();
        loadCardList();
        loadEmailList();
    });

    // 加载卡密统计
    function loadCardStats() {
        fetch('/admin/api/cards/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalCards').textContent = data.stats.total || 0;
                    document.getElementById('activeCards').textContent = data.stats.active || 0;
                    document.getElementById('usedCards').textContent = data.stats.used || 0;
                    document.getElementById('expiredCards').textContent = data.stats.expired || 0;
                }
            })
            .catch(error => {
                console.error('加载统计数据失败:', error);
            });
    }

    // 加载卡密列表
    function loadCardList(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('searchInput').value;
        
        const params = new URLSearchParams({
            page: page,
            per_page: perPage,
            search: searchTerm
        });

        fetch(`/admin/api/cards?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allCards = data.data;
                    filteredCards = allCards;
                    renderCardList(data.data);
                    renderPagination(data.pagination);
                    updateBatchDeleteButton();
                } else {
                    showToast(data.message || '加载卡密列表失败', 'error');
                }
            })
            .catch(error => {
                console.error('加载卡密列表失败:', error);
                showToast('网络错误，请稍后重试', 'error');
            });
    }

    // 渲染卡密列表
    function renderCardList(cards) {
        const tbody = document.getElementById('cardListBody');
        
        if (cards.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 40px; color: #6b7280;">
                        暂无卡密数据
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = cards.map((card, index) => `
            <tr>
                <td>
                    <input type="checkbox" class="card-checkbox" value="${card.id}" 
                           onchange="toggleCardSelection(${card.id})" 
                           ${selectedCards.has(card.id) ? 'checked' : ''}>
                </td>
                <td>${index + 1 + (currentPage - 1) * perPage}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                            ${card.card_key}
                        </code>
                        <button class="btn btn-sm" onclick="copyToClipboard('${card.card_key}')" 
                                title="复制卡密" style="padding: 2px 6px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">
                            📋
                        </button>
                    </div>
                </td>
                <td>${card.used_count}/${card.usage_limit}</td>
                <td>${card.last_used_at ? formatDateTime(card.last_used_at) : '-'}</td>
                <td>${formatExpirationDisplay(card.expired_at)}</td>
                <td>${getBoundEmailInfo(card) || '-'}</td>
                <td>
                    <div style="font-size: 12px;">
                        <div>收取: ${card.email_days_filter || 1}天内</div>
                        ${card.keyword_filter ? `<div>关键词: ${card.keyword_filter.substring(0, 20)}${card.keyword_filter.length > 20 ? '...' : ''}</div>` : '<div>关键词: 不限制</div>'}
                    </div>
                </td>
                <td>${getCardRemarks(card.remarks) || '-'}</td>
                <td>${formatDateTime(card.created_at)}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="showEditModal(${card.id})" 
                                title="编辑">✏️</button>
                        <button class="btn btn-sm btn-success" onclick="apiPickup('${card.card_key}')" 
                                title="API取件">📥</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})" 
                                title="删除">🗑️</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // 复制到剪贴板
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('卡密已复制到剪贴板', 'success');
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    // 备用复制方法
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('卡密已复制到剪贴板', 'success');
        } catch (err) {
            showToast('复制失败，请手动复制', 'error');
        }
        document.body.removeChild(textArea);
    }

    // 从卡密数据中获取绑定邮箱信息
    function getBoundEmailInfo(card) {
        // 优先使用后端返回的bound_email字段（实际邮箱地址）
        if (card.bound_email) {
            return card.bound_email;
        }
        
        // 兼容性：如果有绑定邮箱ID但没有邮箱地址，尝试从下拉框中查找
        if (card.bound_email_id) {
            const emailSelect = document.getElementById('emailSelect');
            if (emailSelect) {
                for (let option of emailSelect.options) {
                    if (option.value == card.bound_email_id) {
                        return option.textContent.split(' ')[0]; // 只返回邮箱地址部分
                    }
                }
            }
            return `邮箱ID: ${card.bound_email_id}`;
        }
        
        // 兼容旧版本的备注绑定方式
        return getBoundEmail(card.remarks);
    }

    // 从备注中提取绑定邮箱
    function getBoundEmail(remarks) {
        if (!remarks) return '';
        const match = remarks.match(/绑定邮箱:\s*([^\s,，；;]+)/);
        return match ? match[1] : '';
    }

    // 从备注中提取实际备注内容（排除绑定邮箱部分）
    function getCardRemarks(remarks) {
        if (!remarks) return '';
        // 如果包含绑定邮箱信息，则提取其他部分
        if (remarks.includes('绑定邮箱:')) {
            return remarks.replace(/绑定邮箱:\s*[^\s,，；;]+\s*[,，；;]?\s*/, '').trim();
        }
        return remarks;
    }
    function getStatusBadge(card) {
        const now = new Date();
        const expiredAt = card.expired_at ? new Date(card.expired_at) : null;
        
        if (card.status === 0) {
            return '<span class="status-badge status-disabled">已禁用</span>';
        }
        
        if (expiredAt && expiredAt < now) {
            return '<span class="status-badge status-expired">已过期</span>';
        }
        
        if (card.used_count >= card.usage_limit) {
            return '<span class="status-badge status-used">已用完</span>';
        }
        
        return '<span class="status-badge status-active">可用</span>';
    }

    // 格式化日期时间（北京时间）
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        
        // 现在数据库已经存储北京时间，直接解析并格式化即可
        let date;
        if (dateString.includes('T')) {
            // ISO格式：2023-12-01T10:30:00Z 或 2023-12-01T10:30:00
            date = new Date(dateString);
        } else if (dateString.includes(' ')) {
            // MySQL格式：2023-12-01 10:30:00
            // 数据库现在存储的是北京时间，直接解析
            date = new Date(dateString);
        } else {
            // 其他格式
            date = new Date(dateString);
        }
        
        // 格式化为中文日期时间格式
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 渲染分页
    function renderPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        totalPages = pagination.pages;
        
        let html = `<div class="pagination-info">共 ${pagination.total} 条记录，第 ${pagination.page} 页，共 ${pagination.pages} 页</div>`;
        
        if (pagination.pages > 1) {
            html += '<div class="pagination-buttons">';
            
            // 上一页
            if (pagination.page > 1) {
                html += `<button class="page-btn" onclick="loadCardList(${pagination.page - 1})">« 上一页</button>`;
            }
            
            // 页码按钮
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.pages, pagination.page + 2);
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="loadCardList(1)">1</button>`;
                if (startPage > 2) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === pagination.page ? 'active' : '';
                html += `<button class="page-btn ${activeClass}" onclick="loadCardList(${i})">${i}</button>`;
            }
            
            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    html += '<span class="page-btn" style="border: none; cursor: default;">...</span>';
                }
                html += `<button class="page-btn" onclick="loadCardList(${pagination.pages})">${pagination.pages}</button>`;
            }
            
            // 下一页
            if (pagination.page < pagination.pages) {
                html += `<button class="page-btn" onclick="loadCardList(${pagination.page + 1})">下一页 »</button>`;
            }
            
            html += '</div>';
        }
        
        container.innerHTML = html;
    }

    // 搜索卡密
    function searchCards() {
        loadCardList(1);
    }

    // 清除搜索
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        loadCardList(1);
    }

    // 改变每页显示数量
    function changePerPage() {
        const select = document.getElementById('perPageSelect');
        perPage = parseInt(select.value);
        loadCardList(1);
    }

    // 刷新卡密列表
    function refreshCardList() {
        selectedCards.clear();
        loadCardStats();
        loadCardList(currentPage);
    }

    // 切换单个卡密选择
    function toggleCardSelection(cardId) {
        if (selectedCards.has(cardId)) {
            selectedCards.delete(cardId);
        } else {
            selectedCards.add(cardId);
        }
        updateSelectAllCheckbox();
        updateBatchDeleteButton();
    }

    // 切换全选
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.card-checkbox');
        
        selectedCards.clear();
        
        if (selectAll.checked) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedCards.add(parseInt(checkbox.value));
            });
        } else {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        updateBatchDeleteButton();
    }

    // 更新全选复选框状态
    function updateSelectAllCheckbox() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.card-checkbox');
        const checkedCount = document.querySelectorAll('.card-checkbox:checked').length;
        
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        selectAll.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
    }

    // 更新批量删除按钮显示
    function updateBatchDeleteButton() {
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        if (selectedCards.size > 0) {
            batchDeleteBtn.style.display = 'inline-block';
            batchDeleteBtn.innerHTML = `<i>🗑️</i> 批量删除 (${selectedCards.size})`;
        } else {
            batchDeleteBtn.style.display = 'none';
        }
    }

    // 显示生成卡密弹窗
    function showGenerateModal() {
        document.getElementById('generateForm').reset();
        document.getElementById('generateModal').classList.add('show');
    }

    // 显示批量生成卡密弹窗
    function showBatchGenerateModal() {
        document.getElementById('batchGenerateForm').reset();
        document.getElementById('batchGenerateModal').classList.add('show');
    }

    // 关闭弹窗
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // 生成单个卡密
    function generateCard() {
        const form = document.getElementById('generateForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'generate',
            usage_limit: parseInt(formData.get('usage_limit')),
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || '',
            expired_at: expired_at,
            remarks: formData.get('remarks') || ''
        };

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('generateModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('生成卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // 批量生成卡密
    function batchGenerateCards() {
        const form = document.getElementById('batchGenerateForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'batch_generate',
            count: parseInt(formData.get('count')),
            usage_limit: parseInt(formData.get('usage_limit')),
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || '',
            expired_at: expired_at,
            remarks: formData.get('remarks') || ''
        };

        if (data.count > 100) {
            showToast('一次最多生成100个卡密', 'error');
            return;
        }

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('batchGenerateModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('批量生成卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // 删除单个卡密
    function deleteCard(cardId) {
        if (!confirm('确定要删除这个卡密吗？此操作不可恢复。')) {
            return;
        }

        fetch('/admin/api/cards', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: cardId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('卡密删除成功', 'success');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('删除卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // 批量删除卡密
    function batchDeleteCards() {
        if (selectedCards.size === 0) {
            showToast('请选择要删除的卡密', 'error');
            return;
        }

        if (!confirm(`确定要删除选中的 ${selectedCards.size} 个卡密吗？此操作不可恢复。`)) {
            return;
        }

        fetch('/admin/api/cards', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                action: 'batch_delete',
                ids: Array.from(selectedCards) 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                selectedCards.clear();
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('批量删除卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // 生成卡密API
    function generateCardAPI() {
        const cardKey = document.getElementById('editCardKey').value;
        if (!cardKey) {
            showToast('请先选择卡密', 'error');
            return;
        }

        // 生成API页面链接
        const apiUrl = `${window.location.origin}/admin/api/cards/generate-api/${cardKey}`;
        
        // 打开API页面
        window.open(apiUrl, '_blank');
        
        // 复制链接到剪贴板
        copyToClipboard(apiUrl);
        
        showToast('API页面已打开，链接已复制到剪贴板', 'success');
    }

    // 加载邮箱列表（用于绑定）- 更新为只获取未绑定的邮箱
    function loadEmailList(callback) {
        // 对于编辑模式，需要获取当前卡密可绑定的邮箱
        const cardId = document.getElementById('editCardId').value;
        
        if (cardId) {
            // 编辑模式：获取可绑定的邮箱
            fetch(`/admin/api/cards/${cardId}/available-emails`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateEmailSelectOptions(data.data);
                        if (callback) callback();
                    }
                })
                .catch(error => {
                    console.error('加载可绑定邮箱列表失败:', error);
                    if (callback) callback();
                });
        } else {
            // 添加模式：获取所有未绑定的邮箱
            fetch('/admin/api/mailbox?per_page=100')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateEmailSelectOptions(data.data);
                        if (callback) callback();
                    }
                })
                .catch(error => {
                    console.error('加载邮箱列表失败:', error);
                    if (callback) callback();
                });
        }
    }
    
    // 更新邮箱选择器选项
    function updateEmailSelectOptions(emails) {
        // 更新绑定邮箱弹窗中的选择器
        const bindEmailSelect = document.getElementById('emailSelect');
        if (bindEmailSelect) {
            bindEmailSelect.innerHTML = '<option value="">请选择邮箱账号</option>';
            emails.forEach(email => {
                const option = document.createElement('option');
                option.value = email.id;
                option.textContent = `${email.email} (${email.server})`;
                bindEmailSelect.appendChild(option);
            });
        }
        
        // 更新编辑弹窗中的选择器
        const editEmailSelect = document.getElementById('editBoundEmailId');
        if (editEmailSelect) {
            const currentValue = editEmailSelect.value; // 保存当前值
            editEmailSelect.innerHTML = '<option value="">请选择邮箱账号</option>';
            emails.forEach(email => {
                const option = document.createElement('option');
                option.value = email.id;
                option.textContent = `${email.email} (${email.server})`;
                editEmailSelect.appendChild(option);
            });
            // 恢复当前值（如果还存在）
            if (currentValue) {
                editEmailSelect.value = currentValue;
            }
        }
    }

    // 显示编辑卡密弹窗
    function showEditModal(cardId) {
        // 从当前加载的卡密列表中找到对应的卡密
        const card = allCards.find(c => c.id === cardId);
        if (!card) {
            showToast('卡密信息未找到', 'error');
            return;
        }
        
        document.getElementById('editCardId').value = card.id;
        document.getElementById('editCardKey').value = card.card_key;
        document.getElementById('editUsageLimit').value = card.usage_limit || 1;
        document.getElementById('editExpiredAt').value = card.expired_at || '';
        document.getElementById('editRemarks').value = getCardRemarks(card.remarks) || '';
        document.getElementById('editBoundEmailId').value = card.bound_email_id || '';
        document.getElementById('editEmailDaysFilter').value = card.email_days_filter || 1;
        document.getElementById('editKeywordFilter').value = card.keyword_filter || '';
        
        // 确保邮箱选择器已加载
        loadEmailList(function() {
            document.getElementById('editModal').classList.add('show');
        });
    }

    // 保存编辑
    function saveEdit() {
        const form = document.getElementById('editForm');
        const formData = new FormData(form);
        
        let expired_at = null;
        try {
            const expirationInput = formData.get('expired_at');
            if (expirationInput && expirationInput.trim()) {
                expired_at = parseExpirationInput(expirationInput);
            }
        } catch (error) {
            showToast(error.message, 'error');
            return;
        }
        
        const data = {
            action: 'edit',
            card_id: parseInt(formData.get('card_id')),
            usage_limit: parseInt(formData.get('usage_limit')),
            expired_at: expired_at,
            remarks: formData.get('remarks') || '',
            bound_email_id: formData.get('bound_email_id') ? parseInt(formData.get('bound_email_id')) : null,
            email_days_filter: parseInt(formData.get('email_days_filter')) || 1,
            keyword_filter: formData.get('keyword_filter') || ''
        };

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('editModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('编辑卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // 格式化日期时间用于输入框（北京时间）
    function formatDateTimeForInput(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        // 转换为北京时间
        const beijingDate = new Date(date.toLocaleString('en-US', {timeZone: 'Asia/Shanghai'}));
        const year = beijingDate.getFullYear();
        const month = String(beijingDate.getMonth() + 1).padStart(2, '0');
        const day = String(beijingDate.getDate()).padStart(2, '0');
        const hours = String(beijingDate.getHours()).padStart(2, '0');
        const minutes = String(beijingDate.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    function showBindEmailModal(cardId, cardKey) {
        document.getElementById('bindCardId').value = cardId;
        document.getElementById('bindCardKey').value = cardKey;
        document.getElementById('bindEmailModal').classList.add('show');
    }

    // 绑定邮箱
    function bindEmail() {
        const form = document.getElementById('bindEmailForm');
        const formData = new FormData(form);
        
        const data = {
            action: 'bind_email',
            card_id: parseInt(formData.get('card_id')),
            email_id: parseInt(formData.get('email_id'))
        };

        if (!data.email_id) {
            showToast('请选择邮箱账号', 'error');
            return;
        }

        fetch('/admin/api/cards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                closeModal('bindEmailModal');
                refreshCardList();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('绑定邮箱失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }

    // API取件 - 复制API链接
    function apiPickup(cardKey) {
        // 生成API页面链接
        const apiUrl = `${window.location.origin}/admin/api/cards/generate-api/${cardKey}`;
        
        // 复制链接到剪贴板
        copyToClipboard(apiUrl);
        
        showToast('API链接已复制到剪贴板', 'success');
    }

    // 点击弹窗外部关闭弹窗
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });

    // ========== 回收站功能 ==========
    
    let currentRecycleBinTab = 'deleted';
    
    // 显示回收站弹窗
    function showRecycleBinModal() {
        currentRecycleBinTab = 'deleted';
        document.getElementById('recycleBinModal').classList.add('show');
        loadRecycleBinData();
    }
    
    // 切换回收站标签
    function switchRecycleBinTab(tab) {
        currentRecycleBinTab = tab;
        
        // 更新按钮状态
        document.getElementById('deletedTabBtn').style.opacity = tab === 'deleted' ? '1' : '0.6';
        document.getElementById('expiredTabBtn').style.opacity = tab === 'expired' ? '1' : '0.6';
        
        // 显示对应内容
        document.getElementById('deletedCardsContent').style.display = tab === 'deleted' ? 'block' : 'none';
        document.getElementById('expiredCardsContent').style.display = tab === 'expired' ? 'block' : 'none';
        
        loadRecycleBinData();
    }
    
    // 加载回收站数据
    function loadRecycleBinData() {
        const loading = document.getElementById('recycleBinLoading');
        loading.style.display = 'block';
        
        fetch(`/admin/api/recycle-bin?type=${currentRecycleBinTab}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderRecycleBinData(data.data, currentRecycleBinTab);
                    updateRecycleBinCounts(data.counts);
                } else {
                    showToast(data.message || '加载回收站数据失败', 'error');
                }
            })
            .catch(error => {
                console.error('加载回收站数据失败:', error);
                showToast('网络错误，请稍后重试', 'error');
            })
            .finally(() => {
                loading.style.display = 'none';
            });
    }
    
    // 渲染回收站数据
    function renderRecycleBinData(cards, type) {
        const bodyId = type === 'deleted' ? 'deletedCardsBody' : 'expiredCardsBody';
        const tbody = document.getElementById(bodyId);
        
        if (cards.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                        暂无${type === 'deleted' ? '已删除' : '已过期'}的卡密
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = cards.map((card, index) => `
            <tr>
                <td>
                    <input type="checkbox" class="recycle-checkbox recycle-checkbox-${type}" 
                           value="${card.id}" onchange="toggleRecycleItemSelection('${type}')">
                </td>
                <td>${index + 1}</td>
                <td>
                    <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                        ${card.card_key}
                    </code>
                </td>
                <td>${card.used_count}/${card.usage_limit}</td>
                <td>${formatDateTime(type === 'deleted' ? card.deleted_at : card.expired_at)}</td>
                <td>${card.reason || (type === 'deleted' ? '手动删除' : '自动过期')}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-sm btn-success" onclick="restoreCard(${card.id}, '${type}')" 
                                title="恢复">🔄</button>
                        <button class="btn btn-sm btn-danger" onclick="permanentDeleteCard(${card.id}, '${type}')" 
                                title="永久删除">❌</button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Reset selection state when data is refreshed
        updateRecycleBatchActions(type);
    }
    
    // 更新回收站计数
    function updateRecycleBinCounts(counts) {
        document.getElementById('deletedCount').textContent = counts.deleted || 0;
        document.getElementById('expiredCount').textContent = counts.expired || 0;
    }
    
    // 恢复卡密
    function restoreCard(cardId, type) {
        if (!confirm('确定要恢复这个卡密吗？恢复后将重新出现在卡密列表中。')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_id: cardId,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('卡密恢复成功', 'success');
                loadRecycleBinData();
                refreshCardList(); // 刷新主列表
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('恢复卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }
    
    // 永久删除卡密
    function permanentDeleteCard(cardId, type) {
        if (!confirm('确定要永久删除这个卡密吗？此操作不可恢复！')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/permanent-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_id: cardId,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('卡密永久删除成功', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('永久删除卡密失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }
    
    // 清空回收站
    function clearRecycleBin() {
        if (!confirm('确定要清空整个回收站吗？此操作将永久删除所有回收站中的卡密，不可恢复！')) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/clear', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('回收站清空成功', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('清空回收站失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }
    
    // ========== 回收站多选功能 ==========
    
    // 切换回收站项目选择状态
    function toggleRecycleItemSelection(type) {
        updateRecycleBatchActions(type);
    }
    
    // 全选/取消全选回收站项目
    function toggleSelectAllRecycleItems(type) {
        const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}`);
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateRecycleBatchActions(type);
    }
    
    // 更新批量操作按钮状态
    function updateRecycleBatchActions(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}`);
        const checkedCount = document.querySelectorAll(`.recycle-checkbox-${type}:checked`).length;
        const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        
        // 更新全选框状态
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        selectAll.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        
        // 显示/隐藏批量操作按钮
        const batchActions = document.getElementById(`${type}BatchActions`);
        const restoreBtn = document.getElementById(`batchRestore${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
        const deleteBtn = document.getElementById(`batchDelete${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
        
        if (checkedCount > 0) {
            batchActions.style.display = 'block';
            restoreBtn.textContent = `🔄 批量恢复 (${checkedCount})`;
            deleteBtn.textContent = `🗑️ 批量永久删除 (${checkedCount})`;
        } else {
            batchActions.style.display = 'none';
        }
    }
    
    // 批量恢复回收站项目
    function batchRestoreRecycleItems(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}:checked`);
        const cardIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (cardIds.length === 0) {
            showToast('请先选择要恢复的卡密', 'warning');
            return;
        }
        
        const typeText = type === 'deleted' ? '已删除' : '已过期';
        if (!confirm(`确定要批量恢复选中的 ${cardIds.length} 个${typeText}卡密吗？恢复后将重新出现在卡密列表中。`)) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_ids: cardIds,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('批量恢复成功', 'success');
                loadRecycleBinData();
                refreshCardList();
            } else {
                showToast(data.message || '批量恢复失败', 'error');
            }
        })
        .catch(error => {
            console.error('批量恢复失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }
    
    // 批量永久删除回收站项目
    function batchPermanentDeleteRecycleItems(type) {
        const checkboxes = document.querySelectorAll(`.recycle-checkbox-${type}:checked`);
        const cardIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (cardIds.length === 0) {
            showToast('请先选择要删除的卡密', 'warning');
            return;
        }
        
        const typeText = type === 'deleted' ? '已删除' : '已过期';
        if (!confirm(`确定要永久删除选中的 ${cardIds.length} 个${typeText}卡密吗？此操作不可恢复！`)) {
            return;
        }
        
        fetch('/admin/api/recycle-bin/permanent-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                card_ids: cardIds,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('批量删除成功', 'success');
                loadRecycleBinData();
            } else {
                showToast(data.message || '批量删除失败', 'error');
            }
        })
        .catch(error => {
            console.error('批量删除失败:', error);
            showToast('网络错误，请稍后重试', 'error');
        });
    }
</script>
{% endblock %}